---
phase: 06-client-provisioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/provisioning/types.ts
  - lib/provisioning/config.ts
  - scripts/provisioning/steps/01-supabase.ts
  - scripts/provisioning/steps/02-database.ts
  - scripts/provisioning/template/schema.sql
autonomous: true
user_setup:
  - service: supabase
    why: "Supabase Management API access for creating client projects"
    env_vars:
      - name: SUPABASE_MANAGEMENT_TOKEN
        source: "Supabase Dashboard -> Account Settings -> Access Tokens -> Generate new token"
      - name: SUPABASE_ORG_ID
        source: "Supabase Dashboard -> Organization Settings -> General -> Organization ID"

must_haves:
  truths:
    - "Running Supabase provisioning step creates a new Supabase project"
    - "New project has all 21 tables from the template schema"
    - "RLS is enabled on all tables immediately after creation"
    - "Provisioning is idempotent - re-running skips existing projects"
  artifacts:
    - path: "lib/provisioning/types.ts"
      provides: "ProvisioningJob, CreatedResources, ProvisioningResult types"
      exports: ["ProvisioningJob", "CreatedResources", "ProvisioningResult", "ProvisioningStep"]
    - path: "lib/provisioning/config.ts"
      provides: "API client configuration with env var validation"
      exports: ["getSupabaseManagementConfig", "validateProvisioningEnv"]
    - path: "scripts/provisioning/steps/01-supabase.ts"
      provides: "createSupabaseProject function with retry and idempotency"
      exports: ["createSupabaseProject", "waitForProjectReady"]
    - path: "scripts/provisioning/steps/02-database.ts"
      provides: "cloneSchemaToProject function"
      exports: ["cloneSchemaToProject", "enableRLSOnAllTables"]
    - path: "scripts/provisioning/template/schema.sql"
      provides: "Complete database schema for new clients"
      contains: "CREATE TABLE"
  key_links:
    - from: "scripts/provisioning/steps/01-supabase.ts"
      to: "Supabase Management API"
      via: "fetch with SUPABASE_MANAGEMENT_TOKEN"
      pattern: "api\\.supabase\\.com/v1/projects"
    - from: "scripts/provisioning/steps/02-database.ts"
      to: "scripts/provisioning/template/schema.sql"
      via: "fs.readFileSync"
      pattern: "readFileSync.*schema\\.sql"
---

<objective>
Create the Supabase project provisioning and database schema cloning infrastructure for new client deployments.

Purpose: This is the foundation of client provisioning - creating isolated Supabase instances with the full DraggonnB schema ensures each client has their own database with complete data isolation.

Output: TypeScript provisioning types, Supabase project creation step with retry logic, database schema cloning step with immediate RLS enablement, and the template schema file.
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris Terblanche\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-client-provisioning/06-RESEARCH.md

# Existing RLS policies to clone into template
@scripts/rls-policies.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provisioning types and configuration</name>
  <files>lib/provisioning/types.ts, lib/provisioning/config.ts</files>
  <action>
Create the foundational types and configuration for the provisioning system:

**lib/provisioning/types.ts:**
```typescript
export interface ProvisioningJob {
  clientId: string;
  clientName: string;
  orgEmail: string;
  tier: 'starter' | 'professional' | 'enterprise';
  createdResources?: CreatedResources;
}

export interface CreatedResources {
  supabaseProjectId?: string;
  supabaseProjectRef?: string;
  supabaseAnonKey?: string;
  supabaseServiceRoleKey?: string;
  supabaseDatabaseUrl?: string;
  githubRepoName?: string;
  githubRepoUrl?: string;
  vercelProjectId?: string;
  vercelDeploymentUrl?: string;
  n8nWorkflowId?: string;
  n8nWebhookUrl?: string;
}

export interface ProvisioningResult {
  success: boolean;
  step: ProvisioningStep;
  data?: Partial<CreatedResources>;
  error?: string;
}

export type ProvisioningStep =
  | 'supabase-project'
  | 'database-schema'
  | 'github-repo'
  | 'vercel-deployment'
  | 'n8n-webhooks'
  | 'finalize';
```

**lib/provisioning/config.ts:**
```typescript
export function validateProvisioningEnv(): { valid: boolean; missing: string[] } {
  const required = [
    'SUPABASE_MANAGEMENT_TOKEN',
    'SUPABASE_ORG_ID',
  ];
  const missing = required.filter(key => !process.env[key]);
  return { valid: missing.length === 0, missing };
}

export function getSupabaseManagementConfig() {
  const token = process.env.SUPABASE_MANAGEMENT_TOKEN;
  const orgId = process.env.SUPABASE_ORG_ID;

  if (!token || !orgId) {
    throw new Error('Missing Supabase Management API credentials');
  }

  return { token, orgId };
}
```

Use zod for runtime validation of API responses.
  </action>
  <verify>
Run: `npx tsc --noEmit lib/provisioning/types.ts lib/provisioning/config.ts`
TypeScript compiles without errors.
  </verify>
  <done>
Types exported: ProvisioningJob, CreatedResources, ProvisioningResult, ProvisioningStep.
Config functions exported: validateProvisioningEnv, getSupabaseManagementConfig.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase project provisioning step</name>
  <files>scripts/provisioning/steps/01-supabase.ts</files>
  <action>
Create the Supabase project creation step with idempotency and retry logic:

1. **Idempotency check:** Before creating, check if project with name `client-{clientId}-prod` already exists in the organization. If exists, return existing project details.

2. **Project creation:** POST to `https://api.supabase.com/v1/projects` with:
   - name: `client-{clientId}-prod`
   - organization_id: from env
   - region: `af-south-1` (South Africa)
   - db_pass: generate secure 32-char password using crypto.randomBytes
   - plan: `pro` (needed for RLS)

3. **Wait for ready:** Poll `GET /v1/projects/{id}` until status is `ACTIVE_HEALTHY`. Use exponential backoff with max 180 seconds timeout.

4. **Return credentials:** Return projectId, projectRef, anonKey, serviceRoleKey, databaseUrl.

Use exponential-backoff library (install: `npm install exponential-backoff`). Handle 429 rate limit responses by triggering retry.

Example structure:
```typescript
import { backOff } from 'exponential-backoff';
import { randomBytes } from 'crypto';

export async function createSupabaseProject(job: ProvisioningJob): Promise<ProvisioningResult> {
  // 1. Check for existing project (idempotency)
  // 2. Create if not exists with backOff wrapper
  // 3. Wait for ACTIVE_HEALTHY
  // 4. Return credentials
}

function generateSecurePassword(): string {
  return randomBytes(24).toString('base64url');
}
```

Do NOT log full API responses (security). Log only projectId and status.
  </action>
  <verify>
Run: `npx tsc --noEmit scripts/provisioning/steps/01-supabase.ts`
TypeScript compiles without errors.
Check that file imports from lib/provisioning/types.ts correctly.
  </verify>
  <done>
createSupabaseProject function creates new Supabase project with idempotency check.
waitForProjectReady function polls until ACTIVE_HEALTHY.
Secure password generation using crypto.randomBytes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create database schema cloning step and template</name>
  <files>scripts/provisioning/steps/02-database.ts, scripts/provisioning/template/schema.sql</files>
  <action>
Create the database schema cloning step:

**scripts/provisioning/template/schema.sql:**
Extract the schema from the existing project. Since we don't have direct DB access, create the template by:
1. Reading the existing `scripts/rls-policies.sql` file
2. Adding the CREATE TABLE statements for all 21 tables (extract structure from RLS file comments)

Tables to include (from RLS file):
- organizations, users
- contacts, companies, deals, activities
- email_campaigns, email_templates, email_sequences, email_sends, email_unsubscribes
- social_posts, social_accounts, content_queue, content_templates
- client_usage_metrics, subscription_history
- analytics_snapshots, platform_metrics
- notifications, audit_log

For each table, create a minimal schema with:
- id (uuid, primary key, default gen_random_uuid())
- organization_id (uuid, references organizations(id)) where applicable
- created_at (timestamptz, default now())
- updated_at (timestamptz, default now())
- Table-specific columns based on common CRM patterns

**scripts/provisioning/steps/02-database.ts:**
```typescript
import { Client } from 'pg';
import * as fs from 'fs';
import * as path from 'path';

export async function cloneSchemaToProject(
  databaseUrl: string,
  projectRef: string
): Promise<ProvisioningResult> {
  // 1. Read template schema
  const schemaPath = path.join(__dirname, '../template/schema.sql');
  const schema = fs.readFileSync(schemaPath, 'utf-8');

  // 2. Connect to new project DB
  const client = new Client({ connectionString: databaseUrl });
  await client.connect();

  try {
    // 3. Execute schema
    await client.query(schema);

    // 4. Enable RLS on all tables
    await enableRLSOnAllTables(client);

    return { success: true, step: 'database-schema' };
  } finally {
    await client.end();
  }
}

export async function enableRLSOnAllTables(client: Client): Promise<void> {
  // Execute RLS enable for all public tables
  const rlsScript = `
    DO $$
    DECLARE
      tbl record;
    BEGIN
      FOR tbl IN
        SELECT tablename FROM pg_tables WHERE schemaname = 'public'
      LOOP
        EXECUTE format('ALTER TABLE %I ENABLE ROW LEVEL SECURITY', tbl.tablename);
      END LOOP;
    END $$;
  `;
  await client.query(rlsScript);
}
```

The pg library is already in devDependencies. Include the RLS policies from scripts/rls-policies.sql in the template schema file so new projects get both structure AND policies.
  </action>
  <verify>
Run: `npx tsc --noEmit scripts/provisioning/steps/02-database.ts`
Check that scripts/provisioning/template/schema.sql exists and contains CREATE TABLE statements.
Check that schema.sql includes RLS policy creation.
  </verify>
  <done>
Template schema contains all 21 tables with proper structure.
RLS policies included in template for immediate security.
cloneSchemaToProject connects via pg and executes schema.
enableRLSOnAllTables ensures RLS enabled on all tables.
  </done>
</task>

</tasks>

<verification>
1. All TypeScript files compile: `npx tsc --noEmit lib/provisioning/*.ts scripts/provisioning/steps/*.ts`
2. Schema template exists: `cat scripts/provisioning/template/schema.sql | head -50`
3. Required dependencies installed: `npm ls exponential-backoff`
4. No secrets in code: `grep -r "MANAGEMENT_TOKEN" scripts/provisioning/` returns only process.env references
</verification>

<success_criteria>
- [ ] lib/provisioning/types.ts exports ProvisioningJob, CreatedResources, ProvisioningResult
- [ ] lib/provisioning/config.ts exports validateProvisioningEnv, getSupabaseManagementConfig
- [ ] scripts/provisioning/steps/01-supabase.ts exports createSupabaseProject with idempotency
- [ ] scripts/provisioning/steps/02-database.ts exports cloneSchemaToProject and enableRLSOnAllTables
- [ ] scripts/provisioning/template/schema.sql contains CREATE TABLE for all 21 tables
- [ ] scripts/provisioning/template/schema.sql contains RLS policies
- [ ] exponential-backoff package installed
- [ ] npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-client-provisioning/06-01-SUMMARY.md`
</output>
