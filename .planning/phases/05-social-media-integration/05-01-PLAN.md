---
phase: 05-social-media-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/04_social_accounts.sql
  - lib/social/types.ts
  - app/api/social/accounts/route.ts
  - app/api/social/accounts/[id]/route.ts
  - app/(dashboard)/settings/social/page.tsx
  - components/social/ConnectedAccountCard.tsx
  - components/social/ConnectAccountButton.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a list of connected social accounts (or empty state if none)"
    - "User can initiate OAuth flow to connect a new account"
    - "User can disconnect an existing social account"
    - "Social accounts are scoped to the user's organization"
  artifacts:
    - path: "supabase/migrations/04_social_accounts.sql"
      provides: "social_accounts table with OAuth token storage"
      contains: "CREATE TABLE.*social_accounts"
    - path: "lib/social/types.ts"
      provides: "Type definitions for social accounts"
      exports: ["SocialAccount", "SocialPlatform"]
    - path: "app/api/social/accounts/route.ts"
      provides: "GET (list) and POST (create) for social accounts"
      exports: ["GET", "POST"]
    - path: "app/(dashboard)/settings/social/page.tsx"
      provides: "Social accounts management UI"
      min_lines: 50
  key_links:
    - from: "app/(dashboard)/settings/social/page.tsx"
      to: "/api/social/accounts"
      via: "fetch for account list"
      pattern: "fetch.*api/social/accounts"
    - from: "app/api/social/accounts/route.ts"
      to: "supabase.from('social_accounts')"
      via: "database query"
      pattern: "from\\(['\"]social_accounts['\"]\\)"
---

<objective>
Create social accounts management foundation: database table, API endpoints, and UI for viewing/managing connected social media accounts.

Purpose: This establishes the infrastructure that Facebook/Instagram (05-02) and LinkedIn (05-03) integrations will use to store OAuth tokens and display connection status.

Output: Migration file, TypeScript types, CRUD API routes, and settings page for social account management.
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris Terblanche\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/rls-policies.sql
@lib/auth/get-user-org.ts
@app/api/content/queue/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create social_accounts table migration and types</name>
  <files>
    supabase/migrations/04_social_accounts.sql
    lib/social/types.ts
  </files>
  <action>
Create the social_accounts table migration:

```sql
-- supabase/migrations/04_social_accounts.sql
CREATE TABLE IF NOT EXISTS social_accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Platform identification
  platform TEXT NOT NULL CHECK (platform IN ('facebook', 'instagram', 'linkedin', 'twitter')),
  platform_user_id TEXT NOT NULL,
  platform_username TEXT,
  platform_display_name TEXT,
  profile_image_url TEXT,

  -- OAuth tokens (encrypted at rest by Supabase)
  access_token TEXT NOT NULL,
  refresh_token TEXT,
  token_expires_at TIMESTAMP,

  -- For Facebook/Instagram: page_id is required for publishing
  page_id TEXT,
  page_name TEXT,
  page_access_token TEXT,

  -- Connection metadata
  scopes TEXT[],
  connected_at TIMESTAMP NOT NULL DEFAULT NOW(),
  last_used_at TIMESTAMP,

  -- Status
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'expired', 'revoked', 'error')),
  error_message TEXT,

  -- Metadata
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

  -- Ensure one account per platform per org (can have multiple pages though)
  UNIQUE(organization_id, platform, platform_user_id)
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_social_accounts_organization_id ON social_accounts(organization_id);
CREATE INDEX IF NOT EXISTS idx_social_accounts_platform ON social_accounts(platform);
CREATE INDEX IF NOT EXISTS idx_social_accounts_status ON social_accounts(status);

-- Trigger for updated_at
CREATE TRIGGER update_social_accounts_updated_at BEFORE UPDATE ON social_accounts
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- RLS (already defined in scripts/rls-policies.sql, but include here for completeness)
ALTER TABLE social_accounts ENABLE ROW LEVEL SECURITY;

-- RLS policies (matching pattern from rls-policies.sql)
CREATE POLICY "Org members can select social_accounts" ON social_accounts
  FOR SELECT TO authenticated
  USING (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()));

CREATE POLICY "Org members can insert social_accounts" ON social_accounts
  FOR INSERT TO authenticated
  WITH CHECK (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()));

CREATE POLICY "Org members can update social_accounts" ON social_accounts
  FOR UPDATE TO authenticated
  USING (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()))
  WITH CHECK (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()));

CREATE POLICY "Org members can delete social_accounts" ON social_accounts
  FOR DELETE TO authenticated
  USING (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()));
```

Create TypeScript types in lib/social/types.ts:

```typescript
export type SocialPlatform = 'facebook' | 'instagram' | 'linkedin' | 'twitter';

export interface SocialAccount {
  id: string;
  organization_id: string;
  platform: SocialPlatform;
  platform_user_id: string;
  platform_username: string | null;
  platform_display_name: string | null;
  profile_image_url: string | null;
  page_id: string | null;
  page_name: string | null;
  scopes: string[] | null;
  connected_at: string;
  last_used_at: string | null;
  status: 'active' | 'expired' | 'revoked' | 'error';
  error_message: string | null;
  created_at: string;
  updated_at: string;
}

export interface ConnectAccountRequest {
  platform: SocialPlatform;
  access_token: string;
  refresh_token?: string;
  token_expires_at?: string;
  platform_user_id: string;
  platform_username?: string;
  platform_display_name?: string;
  profile_image_url?: string;
  page_id?: string;
  page_name?: string;
  page_access_token?: string;
  scopes?: string[];
}

export interface PublishPostRequest {
  account_id: string;
  content: string;
  image_url?: string;
  link_url?: string;
}

export interface PublishPostResponse {
  success: boolean;
  platform_post_id?: string;
  error?: string;
}
```
  </action>
  <verify>
- File `supabase/migrations/04_social_accounts.sql` exists with CREATE TABLE statement
- File `lib/social/types.ts` exists with SocialAccount and SocialPlatform exports
- `npm run build` passes (TypeScript compiles)
  </verify>
  <done>
- social_accounts table migration ready to run in Supabase
- TypeScript types exported for use by API routes and UI
  </done>
</task>

<task type="auto">
  <name>Task 2: Create social accounts API endpoints</name>
  <files>
    app/api/social/accounts/route.ts
    app/api/social/accounts/[id]/route.ts
  </files>
  <action>
Create CRUD API routes following the pattern from app/api/content/queue/route.ts.

**GET /api/social/accounts** - List connected accounts for organization:

```typescript
// app/api/social/accounts/route.ts
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { getUserOrg } from '@/lib/auth/get-user-org'
import type { SocialAccount, ConnectAccountRequest, SocialPlatform } from '@/lib/social/types'

export async function GET() {
  try {
    const { data: userOrg, error: authError } = await getUserOrg()
    if (authError || !userOrg) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const supabase = await createClient()
    const { data: accounts, error } = await supabase
      .from('social_accounts')
      .select('id, platform, platform_username, platform_display_name, profile_image_url, page_name, status, connected_at, last_used_at, error_message')
      .eq('organization_id', userOrg.organizationId)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Error fetching social accounts:', error)
      return NextResponse.json({ error: 'Failed to fetch accounts' }, { status: 500 })
    }

    return NextResponse.json({ accounts: accounts || [] })
  } catch (error) {
    console.error('Social accounts GET error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

**POST /api/social/accounts** - Create new connected account (called after OAuth callback):

```typescript
export async function POST(request: Request) {
  try {
    const { data: userOrg, error: authError } = await getUserOrg()
    if (authError || !userOrg) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const body: ConnectAccountRequest = await request.json()

    // Validate required fields
    if (!body.platform || !body.access_token || !body.platform_user_id) {
      return NextResponse.json(
        { error: 'platform, access_token, and platform_user_id are required' },
        { status: 400 }
      )
    }

    const validPlatforms: SocialPlatform[] = ['facebook', 'instagram', 'linkedin', 'twitter']
    if (!validPlatforms.includes(body.platform)) {
      return NextResponse.json(
        { error: `Invalid platform. Must be one of: ${validPlatforms.join(', ')}` },
        { status: 400 }
      )
    }

    const supabase = await createClient()

    // Upsert to handle reconnection of same account
    const { data: account, error } = await supabase
      .from('social_accounts')
      .upsert({
        organization_id: userOrg.organizationId,
        platform: body.platform,
        platform_user_id: body.platform_user_id,
        platform_username: body.platform_username,
        platform_display_name: body.platform_display_name,
        profile_image_url: body.profile_image_url,
        access_token: body.access_token,
        refresh_token: body.refresh_token,
        token_expires_at: body.token_expires_at,
        page_id: body.page_id,
        page_name: body.page_name,
        page_access_token: body.page_access_token,
        scopes: body.scopes,
        status: 'active',
        error_message: null,
        connected_at: new Date().toISOString(),
        created_by: userOrg.userId,
      }, {
        onConflict: 'organization_id,platform,platform_user_id'
      })
      .select('id, platform, platform_username, platform_display_name, status')
      .single()

    if (error) {
      console.error('Error creating social account:', error)
      return NextResponse.json({ error: 'Failed to save account' }, { status: 500 })
    }

    return NextResponse.json({ account }, { status: 201 })
  } catch (error) {
    console.error('Social accounts POST error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

**DELETE /api/social/accounts/[id]** - Disconnect account:

```typescript
// app/api/social/accounts/[id]/route.ts
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { getUserOrg } from '@/lib/auth/get-user-org'

export async function DELETE(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { data: userOrg, error: authError } = await getUserOrg()
    if (authError || !userOrg) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { id } = await params
    const supabase = await createClient()

    // Delete only if belongs to user's organization
    const { error } = await supabase
      .from('social_accounts')
      .delete()
      .eq('id', id)
      .eq('organization_id', userOrg.organizationId)

    if (error) {
      console.error('Error deleting social account:', error)
      return NextResponse.json({ error: 'Failed to disconnect account' }, { status: 500 })
    }

    return NextResponse.json({ success: true })
  } catch (error) {
    console.error('Social accounts DELETE error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}

export async function GET(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { data: userOrg, error: authError } = await getUserOrg()
    if (authError || !userOrg) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { id } = await params
    const supabase = await createClient()

    const { data: account, error } = await supabase
      .from('social_accounts')
      .select('id, platform, platform_username, platform_display_name, profile_image_url, page_name, status, connected_at, last_used_at, error_message')
      .eq('id', id)
      .eq('organization_id', userOrg.organizationId)
      .single()

    if (error || !account) {
      return NextResponse.json({ error: 'Account not found' }, { status: 404 })
    }

    return NextResponse.json({ account })
  } catch (error) {
    console.error('Social account GET error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```
  </action>
  <verify>
- `npm run build` passes
- Files exist at app/api/social/accounts/route.ts and app/api/social/accounts/[id]/route.ts
- Both files export the correct HTTP methods
  </verify>
  <done>
- GET /api/social/accounts returns list of connected accounts
- POST /api/social/accounts creates/updates a connected account
- DELETE /api/social/accounts/[id] removes a connected account
- GET /api/social/accounts/[id] returns single account details
  </done>
</task>

<task type="auto">
  <name>Task 3: Create social accounts settings page and components</name>
  <files>
    app/(dashboard)/settings/social/page.tsx
    components/social/ConnectedAccountCard.tsx
    components/social/ConnectAccountButton.tsx
  </files>
  <action>
Create the settings page and components. Follow the styling patterns from existing dashboard pages.

**ConnectedAccountCard component:**

```typescript
// components/social/ConnectedAccountCard.tsx
'use client'

import { useState } from 'react'
import { Facebook, Instagram, Linkedin, Twitter, Trash2, AlertCircle, CheckCircle } from 'lucide-react'
import type { SocialAccount } from '@/lib/social/types'

interface ConnectedAccountCardProps {
  account: SocialAccount
  onDisconnect: (id: string) => Promise<void>
}

const platformIcons = {
  facebook: Facebook,
  instagram: Instagram,
  linkedin: Linkedin,
  twitter: Twitter,
}

const platformColors = {
  facebook: 'text-blue-600',
  instagram: 'text-pink-600',
  linkedin: 'text-blue-700',
  twitter: 'text-sky-500',
}

export function ConnectedAccountCard({ account, onDisconnect }: ConnectedAccountCardProps) {
  const [isDisconnecting, setIsDisconnecting] = useState(false)
  const Icon = platformIcons[account.platform]

  const handleDisconnect = async () => {
    if (!confirm(`Disconnect ${account.platform_display_name || account.platform_username}?`)) return
    setIsDisconnecting(true)
    try {
      await onDisconnect(account.id)
    } finally {
      setIsDisconnecting(false)
    }
  }

  return (
    <div className="flex items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
      <div className="flex items-center gap-4">
        <div className={`p-2 rounded-full bg-gray-100 dark:bg-gray-700 ${platformColors[account.platform]}`}>
          <Icon className="w-6 h-6" />
        </div>
        <div>
          <div className="flex items-center gap-2">
            <span className="font-medium text-gray-900 dark:text-white">
              {account.platform_display_name || account.platform_username || account.platform}
            </span>
            {account.page_name && (
              <span className="text-sm text-gray-500">({account.page_name})</span>
            )}
            {account.status === 'active' ? (
              <CheckCircle className="w-4 h-4 text-green-500" />
            ) : (
              <AlertCircle className="w-4 h-4 text-red-500" />
            )}
          </div>
          <p className="text-sm text-gray-500 dark:text-gray-400">
            Connected {new Date(account.connected_at).toLocaleDateString()}
            {account.status !== 'active' && (
              <span className="text-red-500 ml-2">
                ({account.status}{account.error_message ? `: ${account.error_message}` : ''})
              </span>
            )}
          </p>
        </div>
      </div>
      <button
        onClick={handleDisconnect}
        disabled={isDisconnecting}
        className="p-2 text-gray-400 hover:text-red-500 disabled:opacity-50"
        title="Disconnect account"
      >
        <Trash2 className="w-5 h-5" />
      </button>
    </div>
  )
}
```

**ConnectAccountButton component:**

```typescript
// components/social/ConnectAccountButton.tsx
'use client'

import { Facebook, Instagram, Linkedin, Twitter, Plus } from 'lucide-react'
import type { SocialPlatform } from '@/lib/social/types'

interface ConnectAccountButtonProps {
  platform: SocialPlatform
  disabled?: boolean
}

const platformConfig = {
  facebook: {
    icon: Facebook,
    label: 'Connect Facebook',
    color: 'bg-blue-600 hover:bg-blue-700',
    oauthPath: '/api/auth/social/facebook',
  },
  instagram: {
    icon: Instagram,
    label: 'Connect Instagram',
    color: 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600',
    oauthPath: '/api/auth/social/facebook', // Instagram uses Facebook Graph API
  },
  linkedin: {
    icon: Linkedin,
    label: 'Connect LinkedIn',
    color: 'bg-blue-700 hover:bg-blue-800',
    oauthPath: '/api/auth/social/linkedin',
  },
  twitter: {
    icon: Twitter,
    label: 'Connect Twitter/X',
    color: 'bg-black hover:bg-gray-800',
    oauthPath: '/api/auth/social/twitter',
  },
}

export function ConnectAccountButton({ platform, disabled }: ConnectAccountButtonProps) {
  const config = platformConfig[platform]
  const Icon = config.icon

  const handleConnect = () => {
    // Redirect to OAuth flow
    window.location.href = config.oauthPath
  }

  return (
    <button
      onClick={handleConnect}
      disabled={disabled}
      className={`flex items-center gap-2 px-4 py-2 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${config.color}`}
    >
      <Icon className="w-5 h-5" />
      <span>{config.label}</span>
    </button>
  )
}

export function ConnectAccountDropdown() {
  return (
    <div className="relative group">
      <button className="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
        <Plus className="w-5 h-5" />
        <span>Connect Account</span>
      </button>
      <div className="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
        <div className="p-2 space-y-1">
          {(['facebook', 'instagram', 'linkedin'] as SocialPlatform[]).map((platform) => {
            const config = platformConfig[platform]
            const Icon = config.icon
            return (
              <button
                key={platform}
                onClick={() => window.location.href = config.oauthPath}
                className="flex items-center gap-3 w-full px-3 py-2 text-left text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"
              >
                <Icon className="w-5 h-5" />
                <span>{config.label.replace('Connect ', '')}</span>
              </button>
            )
          })}
        </div>
      </div>
    </div>
  )
}
```

**Settings page:**

```typescript
// app/(dashboard)/settings/social/page.tsx
'use client'

import { useEffect, useState } from 'react'
import { ConnectedAccountCard } from '@/components/social/ConnectedAccountCard'
import { ConnectAccountDropdown } from '@/components/social/ConnectAccountButton'
import { EmptyState } from '@/components/dashboard/EmptyState'
import { Share2, Loader2 } from 'lucide-react'
import type { SocialAccount } from '@/lib/social/types'

export default function SocialAccountsPage() {
  const [accounts, setAccounts] = useState<SocialAccount[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    fetchAccounts()
  }, [])

  const fetchAccounts = async () => {
    try {
      const res = await fetch('/api/social/accounts')
      if (!res.ok) throw new Error('Failed to fetch accounts')
      const data = await res.json()
      setAccounts(data.accounts)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load accounts')
    } finally {
      setLoading(false)
    }
  }

  const handleDisconnect = async (id: string) => {
    const res = await fetch(`/api/social/accounts/${id}`, { method: 'DELETE' })
    if (!res.ok) throw new Error('Failed to disconnect')
    setAccounts(accounts.filter(a => a.id !== id))
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Social Accounts</h1>
          <p className="text-gray-500 dark:text-gray-400 mt-1">
            Connect your social media accounts to publish content directly from DraggonnB
          </p>
        </div>
        <ConnectAccountDropdown />
      </div>

      {error && (
        <div className="p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg">
          {error}
        </div>
      )}

      {accounts.length === 0 ? (
        <EmptyState
          icon={Share2}
          title="No accounts connected"
          description="Connect your social media accounts to start publishing content"
        />
      ) : (
        <div className="space-y-4">
          {accounts.map((account) => (
            <ConnectedAccountCard
              key={account.id}
              account={account}
              onDisconnect={handleDisconnect}
            />
          ))}
        </div>
      )}

      <div className="mt-8 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
        <h3 className="font-medium text-gray-900 dark:text-white mb-2">Supported Platforms</h3>
        <ul className="text-sm text-gray-600 dark:text-gray-400 space-y-1">
          <li>• <strong>Facebook</strong> - Publish to Pages (requires Page admin access)</li>
          <li>• <strong>Instagram</strong> - Publish to Business/Creator accounts (via Facebook)</li>
          <li>• <strong>LinkedIn</strong> - Publish to personal profiles and company pages</li>
        </ul>
      </div>
    </div>
  )
}
```

Also add a link to this page in the sidebar navigation. Look for the sidebar component and add a "Social Accounts" or "Settings" link.
  </action>
  <verify>
- `npm run build` passes
- Files exist at specified paths
- Visit http://localhost:3000/settings/social shows the page (dev server)
  </verify>
  <done>
- Social accounts settings page displays connected accounts or empty state
- Connect button dropdown shows available platforms
- Disconnect button removes account from list
- Page follows existing dashboard styling patterns
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Migration file exists and contains valid SQL
3. TypeScript types compile
4. API routes handle auth and return proper responses
5. Settings page renders without errors
</verification>

<success_criteria>
- [ ] social_accounts migration file ready to run
- [ ] TypeScript types for social accounts exported
- [ ] GET /api/social/accounts returns account list
- [ ] POST /api/social/accounts creates new account
- [ ] DELETE /api/social/accounts/[id] removes account
- [ ] Settings page at /settings/social shows accounts
- [ ] Empty state shown when no accounts connected
- [ ] npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-media-integration/05-01-SUMMARY.md`
</output>
