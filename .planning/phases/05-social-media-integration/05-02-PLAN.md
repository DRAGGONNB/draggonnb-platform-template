---
phase: 05-social-media-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - lib/social/facebook.ts
  - app/api/auth/social/facebook/route.ts
  - app/api/auth/social/facebook/callback/route.ts
  - app/api/social/publish/facebook/route.ts
  - .env.example
autonomous: false
user_setup:
  - service: facebook
    why: "OAuth authentication and Graph API access for publishing"
    env_vars:
      - name: FACEBOOK_APP_ID
        source: "Meta for Developers -> Your App -> Settings -> Basic -> App ID"
      - name: FACEBOOK_APP_SECRET
        source: "Meta for Developers -> Your App -> Settings -> Basic -> App Secret"
    dashboard_config:
      - task: "Create Facebook App"
        location: "https://developers.facebook.com/apps -> Create App -> Business type"
      - task: "Add Facebook Login product"
        location: "App Dashboard -> Add Product -> Facebook Login"
      - task: "Configure OAuth redirect URI"
        location: "Facebook Login -> Settings -> Valid OAuth Redirect URIs: https://yourdomain.com/api/auth/social/facebook/callback"
      - task: "Request pages_manage_posts permission"
        location: "App Review -> Permissions and Features -> pages_manage_posts"
      - task: "Request instagram_basic and instagram_content_publish (for Instagram)"
        location: "App Review -> Permissions and Features"

must_haves:
  truths:
    - "User can click Connect Facebook and complete OAuth flow"
    - "After OAuth, user's Facebook account appears in connected accounts list"
    - "User can publish a post to their Facebook Page via the API"
    - "Instagram Business accounts connected via Facebook Graph API work"
  artifacts:
    - path: "lib/social/facebook.ts"
      provides: "Facebook Graph API client for OAuth and publishing"
      exports: ["getFacebookAuthUrl", "exchangeFacebookCode", "publishToFacebookPage"]
    - path: "app/api/auth/social/facebook/route.ts"
      provides: "Initiates Facebook OAuth redirect"
      exports: ["GET"]
    - path: "app/api/auth/social/facebook/callback/route.ts"
      provides: "Handles OAuth callback and stores tokens"
      exports: ["GET"]
    - path: "app/api/social/publish/facebook/route.ts"
      provides: "Publishes content to Facebook/Instagram"
      exports: ["POST"]
  key_links:
    - from: "app/api/auth/social/facebook/route.ts"
      to: "lib/social/facebook.ts"
      via: "getFacebookAuthUrl call"
      pattern: "getFacebookAuthUrl"
    - from: "app/api/auth/social/facebook/callback/route.ts"
      to: "/api/social/accounts"
      via: "POST to save account"
      pattern: "fetch.*api/social/accounts"
    - from: "app/api/social/publish/facebook/route.ts"
      to: "graph.facebook.com"
      via: "Graph API POST request"
      pattern: "graph\\.facebook\\.com"
---

<objective>
Implement Facebook/Instagram OAuth flow and post publishing via Facebook Graph API.

Purpose: Enable users to connect their Facebook Page and Instagram Business accounts, then publish social media posts directly from DraggonnB.

Output: OAuth routes, Graph API client library, and publish endpoint for Facebook/Instagram.
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Chris Terblanche\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-media-integration/05-01-SUMMARY.md
@lib/social/types.ts
@app/api/social/accounts/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Facebook Graph API client library</name>
  <files>
    lib/social/facebook.ts
    .env.example
  </files>
  <action>
Create the Facebook Graph API client. This handles OAuth URL generation, token exchange, fetching user/page info, and publishing.

**Key Facebook Graph API endpoints:**
- OAuth: `https://www.facebook.com/v19.0/dialog/oauth`
- Token exchange: `https://graph.facebook.com/v19.0/oauth/access_token`
- User info: `https://graph.facebook.com/v19.0/me`
- User pages: `https://graph.facebook.com/v19.0/me/accounts`
- Publish to page: `https://graph.facebook.com/v19.0/{page-id}/feed`
- Instagram accounts: `https://graph.facebook.com/v19.0/{page-id}?fields=instagram_business_account`
- Publish to Instagram: `https://graph.facebook.com/v19.0/{ig-user-id}/media` + `media_publish`

```typescript
// lib/social/facebook.ts

const GRAPH_API_VERSION = 'v19.0'
const GRAPH_BASE_URL = `https://graph.facebook.com/${GRAPH_API_VERSION}`
const OAUTH_BASE_URL = `https://www.facebook.com/${GRAPH_API_VERSION}/dialog/oauth`

// Required scopes for publishing
const FACEBOOK_SCOPES = [
  'public_profile',
  'pages_show_list',
  'pages_read_engagement',
  'pages_manage_posts',
  // Instagram scopes (if app has them approved)
  'instagram_basic',
  'instagram_content_publish',
].join(',')

interface FacebookConfig {
  appId: string
  appSecret: string
  redirectUri: string
}

function getConfig(): FacebookConfig {
  const appId = process.env.FACEBOOK_APP_ID
  const appSecret = process.env.FACEBOOK_APP_SECRET
  const redirectUri = `${process.env.NEXT_PUBLIC_APP_URL}/api/auth/social/facebook/callback`

  if (!appId || !appSecret) {
    throw new Error('Facebook App ID and Secret must be configured')
  }

  return { appId, appSecret, redirectUri }
}

/**
 * Generate Facebook OAuth authorization URL
 */
export function getFacebookAuthUrl(state: string): string {
  const config = getConfig()
  const params = new URLSearchParams({
    client_id: config.appId,
    redirect_uri: config.redirectUri,
    scope: FACEBOOK_SCOPES,
    response_type: 'code',
    state,
  })
  return `${OAUTH_BASE_URL}?${params.toString()}`
}

/**
 * Exchange authorization code for access token
 */
export async function exchangeFacebookCode(code: string): Promise<{
  access_token: string
  token_type: string
  expires_in?: number
}> {
  const config = getConfig()
  const params = new URLSearchParams({
    client_id: config.appId,
    client_secret: config.appSecret,
    redirect_uri: config.redirectUri,
    code,
  })

  const response = await fetch(`${GRAPH_BASE_URL}/oauth/access_token?${params.toString()}`)
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error?.message || 'Failed to exchange code for token')
  }

  return response.json()
}

/**
 * Exchange short-lived token for long-lived token (60 days)
 */
export async function getLongLivedToken(shortLivedToken: string): Promise<{
  access_token: string
  token_type: string
  expires_in: number
}> {
  const config = getConfig()
  const params = new URLSearchParams({
    grant_type: 'fb_exchange_token',
    client_id: config.appId,
    client_secret: config.appSecret,
    fb_exchange_token: shortLivedToken,
  })

  const response = await fetch(`${GRAPH_BASE_URL}/oauth/access_token?${params.toString()}`)
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error?.message || 'Failed to get long-lived token')
  }

  return response.json()
}

/**
 * Get Facebook user profile
 */
export async function getFacebookUser(accessToken: string): Promise<{
  id: string
  name: string
  picture?: { data: { url: string } }
}> {
  const response = await fetch(
    `${GRAPH_BASE_URL}/me?fields=id,name,picture&access_token=${accessToken}`
  )
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error?.message || 'Failed to get user info')
  }
  return response.json()
}

/**
 * Get user's Facebook Pages (where they can publish)
 */
export async function getFacebookPages(accessToken: string): Promise<Array<{
  id: string
  name: string
  access_token: string
  category: string
  instagram_business_account?: { id: string }
}>> {
  const response = await fetch(
    `${GRAPH_BASE_URL}/me/accounts?fields=id,name,access_token,category,instagram_business_account&access_token=${accessToken}`
  )
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error?.message || 'Failed to get pages')
  }
  const data = await response.json()
  return data.data || []
}

/**
 * Publish a post to a Facebook Page
 */
export async function publishToFacebookPage(
  pageId: string,
  pageAccessToken: string,
  content: {
    message: string
    link?: string
    // For photo posts, use published=false first to upload, then publish
  }
): Promise<{ id: string }> {
  const response = await fetch(`${GRAPH_BASE_URL}/${pageId}/feed`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      message: content.message,
      link: content.link,
      access_token: pageAccessToken,
    }),
  })

  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error?.message || 'Failed to publish to Facebook')
  }

  return response.json()
}

/**
 * Publish a photo post to Instagram Business Account
 * Two-step process: 1) Create media container, 2) Publish it
 */
export async function publishToInstagram(
  igUserId: string,
  accessToken: string,
  content: {
    caption: string
    image_url: string // Must be publicly accessible URL
  }
): Promise<{ id: string }> {
  // Step 1: Create media container
  const createResponse = await fetch(`${GRAPH_BASE_URL}/${igUserId}/media`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      image_url: content.image_url,
      caption: content.caption,
      access_token: accessToken,
    }),
  })

  if (!createResponse.ok) {
    const error = await createResponse.json()
    throw new Error(error.error?.message || 'Failed to create Instagram media')
  }

  const { id: containerId } = await createResponse.json()

  // Step 2: Publish the container
  const publishResponse = await fetch(`${GRAPH_BASE_URL}/${igUserId}/media_publish`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      creation_id: containerId,
      access_token: accessToken,
    }),
  })

  if (!publishResponse.ok) {
    const error = await publishResponse.json()
    throw new Error(error.error?.message || 'Failed to publish to Instagram')
  }

  return publishResponse.json()
}

/**
 * Publish text-only post to Instagram (Threads-style, requires different approach)
 * Note: Instagram API requires images for feed posts. Text-only is for Stories/Reels.
 */
export async function canPublishToInstagram(imageUrl?: string): boolean {
  // Instagram feed posts require an image
  return !!imageUrl
}
```

**Update .env.example** - add Facebook credentials:

```
# Facebook/Instagram (Meta Graph API)
FACEBOOK_APP_ID=your_facebook_app_id
FACEBOOK_APP_SECRET=your_facebook_app_secret
```
  </action>
  <verify>
- File `lib/social/facebook.ts` exists with all exports
- `.env.example` has FACEBOOK_APP_ID and FACEBOOK_APP_SECRET
- `npm run build` passes (TypeScript compiles)
  </verify>
  <done>
- Facebook Graph API client ready with OAuth, token exchange, and publish functions
- Environment variables documented in .env.example
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Facebook OAuth routes</name>
  <files>
    app/api/auth/social/facebook/route.ts
    app/api/auth/social/facebook/callback/route.ts
  </files>
  <action>
Create the OAuth initiation and callback routes.

**OAuth initiation route** - Redirects to Facebook login:

```typescript
// app/api/auth/social/facebook/route.ts
import { NextResponse } from 'next/server'
import { cookies } from 'next/headers'
import { getFacebookAuthUrl } from '@/lib/social/facebook'
import { getUserOrg } from '@/lib/auth/get-user-org'

export async function GET() {
  try {
    // Verify user is authenticated
    const { data: userOrg, error } = await getUserOrg()
    if (error || !userOrg) {
      return NextResponse.redirect(new URL('/login', process.env.NEXT_PUBLIC_APP_URL))
    }

    // Generate state for CSRF protection
    const state = crypto.randomUUID()

    // Store state in cookie for verification in callback
    const cookieStore = await cookies()
    cookieStore.set('fb_oauth_state', state, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 600, // 10 minutes
      path: '/',
    })

    // Redirect to Facebook OAuth
    const authUrl = getFacebookAuthUrl(state)
    return NextResponse.redirect(authUrl)
  } catch (error) {
    console.error('Facebook OAuth init error:', error)
    return NextResponse.redirect(
      new URL('/settings/social?error=oauth_init_failed', process.env.NEXT_PUBLIC_APP_URL)
    )
  }
}
```

**OAuth callback route** - Handles the redirect from Facebook:

```typescript
// app/api/auth/social/facebook/callback/route.ts
import { NextResponse } from 'next/server'
import { cookies } from 'next/headers'
import {
  exchangeFacebookCode,
  getLongLivedToken,
  getFacebookUser,
  getFacebookPages,
} from '@/lib/social/facebook'
import { getUserOrg } from '@/lib/auth/get-user-org'
import { createClient } from '@/lib/supabase/server'

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const code = searchParams.get('code')
  const state = searchParams.get('state')
  const errorParam = searchParams.get('error')

  const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'
  const settingsUrl = `${baseUrl}/settings/social`

  // Handle OAuth errors
  if (errorParam) {
    console.error('Facebook OAuth error:', errorParam, searchParams.get('error_description'))
    return NextResponse.redirect(`${settingsUrl}?error=facebook_denied`)
  }

  if (!code || !state) {
    return NextResponse.redirect(`${settingsUrl}?error=missing_params`)
  }

  try {
    // Verify state for CSRF protection
    const cookieStore = await cookies()
    const storedState = cookieStore.get('fb_oauth_state')?.value
    cookieStore.delete('fb_oauth_state')

    if (state !== storedState) {
      console.error('State mismatch:', { received: state, stored: storedState })
      return NextResponse.redirect(`${settingsUrl}?error=invalid_state`)
    }

    // Verify user is authenticated
    const { data: userOrg, error: authError } = await getUserOrg()
    if (authError || !userOrg) {
      return NextResponse.redirect(`${baseUrl}/login`)
    }

    // Exchange code for token
    const tokenData = await exchangeFacebookCode(code)

    // Get long-lived token (60 days instead of 1-2 hours)
    const longLivedToken = await getLongLivedToken(tokenData.access_token)

    // Get user info
    const fbUser = await getFacebookUser(longLivedToken.access_token)

    // Get user's pages (required for publishing)
    const pages = await getFacebookPages(longLivedToken.access_token)

    if (pages.length === 0) {
      return NextResponse.redirect(`${settingsUrl}?error=no_pages`)
    }

    // For now, connect the first page (could add page selection UI later)
    const primaryPage = pages[0]

    // Calculate token expiry
    const expiresAt = new Date()
    expiresAt.setSeconds(expiresAt.getSeconds() + longLivedToken.expires_in)

    // Save to social_accounts via API
    const supabase = await createClient()
    const { error: saveError } = await supabase.from('social_accounts').upsert({
      organization_id: userOrg.organizationId,
      platform: 'facebook',
      platform_user_id: fbUser.id,
      platform_username: fbUser.name,
      platform_display_name: fbUser.name,
      profile_image_url: fbUser.picture?.data?.url,
      access_token: longLivedToken.access_token,
      token_expires_at: expiresAt.toISOString(),
      page_id: primaryPage.id,
      page_name: primaryPage.name,
      page_access_token: primaryPage.access_token,
      scopes: ['pages_manage_posts', 'pages_read_engagement'],
      status: 'active',
      connected_at: new Date().toISOString(),
      created_by: userOrg.userId,
    }, {
      onConflict: 'organization_id,platform,platform_user_id'
    })

    if (saveError) {
      console.error('Error saving Facebook account:', saveError)
      return NextResponse.redirect(`${settingsUrl}?error=save_failed`)
    }

    // Also save Instagram if the page has an IG business account
    if (primaryPage.instagram_business_account) {
      await supabase.from('social_accounts').upsert({
        organization_id: userOrg.organizationId,
        platform: 'instagram',
        platform_user_id: primaryPage.instagram_business_account.id,
        platform_display_name: `${primaryPage.name} (Instagram)`,
        access_token: primaryPage.access_token, // Uses page access token
        page_id: primaryPage.instagram_business_account.id,
        page_name: primaryPage.name,
        page_access_token: primaryPage.access_token,
        scopes: ['instagram_basic', 'instagram_content_publish'],
        status: 'active',
        connected_at: new Date().toISOString(),
        created_by: userOrg.userId,
      }, {
        onConflict: 'organization_id,platform,platform_user_id'
      })
    }

    return NextResponse.redirect(`${settingsUrl}?success=facebook_connected`)
  } catch (error) {
    console.error('Facebook OAuth callback error:', error)
    return NextResponse.redirect(`${settingsUrl}?error=callback_failed`)
  }
}
```
  </action>
  <verify>
- Files exist at app/api/auth/social/facebook/route.ts and callback/route.ts
- `npm run build` passes
- OAuth flow preserves state in cookie for CSRF protection
  </verify>
  <done>
- GET /api/auth/social/facebook redirects to Facebook OAuth
- GET /api/auth/social/facebook/callback handles token exchange and saves account
- CSRF protection via state parameter
- Long-lived token obtained for 60-day validity
- Instagram Business account auto-connected if linked to Page
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Facebook/Instagram publish endpoint</name>
  <files>
    app/api/social/publish/facebook/route.ts
  </files>
  <action>
Create the publish endpoint that posts content to Facebook Pages and Instagram.

```typescript
// app/api/social/publish/facebook/route.ts
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { getUserOrg } from '@/lib/auth/get-user-org'
import { publishToFacebookPage, publishToInstagram, canPublishToInstagram } from '@/lib/social/facebook'

interface PublishRequest {
  account_id: string
  content: string
  image_url?: string
  link_url?: string
}

export async function POST(request: Request) {
  try {
    const { data: userOrg, error: authError } = await getUserOrg()
    if (authError || !userOrg) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const body: PublishRequest = await request.json()

    if (!body.account_id || !body.content) {
      return NextResponse.json(
        { error: 'account_id and content are required' },
        { status: 400 }
      )
    }

    const supabase = await createClient()

    // Get the social account
    const { data: account, error: fetchError } = await supabase
      .from('social_accounts')
      .select('*')
      .eq('id', body.account_id)
      .eq('organization_id', userOrg.organizationId)
      .single()

    if (fetchError || !account) {
      return NextResponse.json({ error: 'Account not found' }, { status: 404 })
    }

    if (account.status !== 'active') {
      return NextResponse.json(
        { error: `Account is ${account.status}. Please reconnect.` },
        { status: 400 }
      )
    }

    // Check token expiry
    if (account.token_expires_at && new Date(account.token_expires_at) < new Date()) {
      // Mark as expired
      await supabase
        .from('social_accounts')
        .update({ status: 'expired', error_message: 'Token expired' })
        .eq('id', account.id)

      return NextResponse.json(
        { error: 'Token expired. Please reconnect your account.' },
        { status: 401 }
      )
    }

    let result: { id: string }

    if (account.platform === 'facebook') {
      // Publish to Facebook Page
      if (!account.page_id || !account.page_access_token) {
        return NextResponse.json(
          { error: 'No Facebook Page connected to this account' },
          { status: 400 }
        )
      }

      result = await publishToFacebookPage(
        account.page_id,
        account.page_access_token,
        {
          message: body.content,
          link: body.link_url,
        }
      )
    } else if (account.platform === 'instagram') {
      // Publish to Instagram
      if (!body.image_url) {
        return NextResponse.json(
          { error: 'Instagram posts require an image_url' },
          { status: 400 }
        )
      }

      if (!account.page_id || !account.page_access_token) {
        return NextResponse.json(
          { error: 'No Instagram Business account connected' },
          { status: 400 }
        )
      }

      result = await publishToInstagram(
        account.page_id,
        account.page_access_token,
        {
          caption: body.content,
          image_url: body.image_url,
        }
      )
    } else {
      return NextResponse.json(
        { error: `Platform ${account.platform} not supported by this endpoint` },
        { status: 400 }
      )
    }

    // Update last_used_at
    await supabase
      .from('social_accounts')
      .update({ last_used_at: new Date().toISOString() })
      .eq('id', account.id)

    return NextResponse.json({
      success: true,
      platform: account.platform,
      platform_post_id: result.id,
    })
  } catch (error) {
    console.error('Facebook publish error:', error)
    const message = error instanceof Error ? error.message : 'Failed to publish'
    return NextResponse.json({ error: message }, { status: 500 })
  }
}
```
  </action>
  <verify>
- File exists at app/api/social/publish/facebook/route.ts
- `npm run build` passes
- POST endpoint validates account ownership and status before publishing
  </verify>
  <done>
- POST /api/social/publish/facebook publishes to Facebook Pages
- POST /api/social/publish/facebook with Instagram account publishes to Instagram
- Token expiry checked and account marked as expired if needed
- last_used_at updated on successful publish
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Facebook/Instagram OAuth flow and publish API</what-built>
  <how-to-verify>
1. Ensure you have configured Facebook App credentials:
   - FACEBOOK_APP_ID and FACEBOOK_APP_SECRET in .env.local
   - OAuth redirect URI configured in Facebook Developer Console

2. Run the migration (04_social_accounts.sql) in Supabase SQL Editor

3. Start dev server: `npm run dev`

4. Navigate to http://localhost:3000/settings/social

5. Click "Connect Facebook" and complete OAuth flow
   - You should be redirected to Facebook login
   - After authorizing, you should be redirected back
   - Your Facebook Page should appear in the connected accounts list

6. Test publish (optional, requires approved permissions):
   ```bash
   curl -X POST http://localhost:3000/api/social/publish/facebook \
     -H "Content-Type: application/json" \
     -d '{"account_id": "YOUR_ACCOUNT_ID", "content": "Test post from DraggonnB!"}'
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if OAuth flow and account display work, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Facebook OAuth redirect works (even without valid credentials, redirect should happen)
3. Callback route handles state verification
4. Publish endpoint validates inputs and checks account ownership
</verification>

<success_criteria>
- [ ] lib/social/facebook.ts exports OAuth and publish functions
- [ ] .env.example documents FACEBOOK_APP_ID and FACEBOOK_APP_SECRET
- [ ] GET /api/auth/social/facebook redirects to Facebook
- [ ] GET /api/auth/social/facebook/callback saves account after OAuth
- [ ] POST /api/social/publish/facebook publishes to Facebook/Instagram
- [ ] Token expiry is checked before publishing
- [ ] npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-media-integration/05-02-SUMMARY.md`
</output>
