---
phase: 05-social-media-integration
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - lib/social/linkedin.ts
  - app/api/auth/social/linkedin/route.ts
  - app/api/auth/social/linkedin/callback/route.ts
  - app/api/social/publish/linkedin/route.ts
  - .env.example
autonomous: false
user_setup:
  - service: linkedin
    why: "OAuth authentication and API access for publishing"
    env_vars:
      - name: LINKEDIN_CLIENT_ID
        source: "LinkedIn Developer Portal -> Your App -> Auth -> Client ID"
      - name: LINKEDIN_CLIENT_SECRET
        source: "LinkedIn Developer Portal -> Your App -> Auth -> Client Secret"
    dashboard_config:
      - task: "Create LinkedIn App"
        location: "https://www.linkedin.com/developers/apps -> Create App"
      - task: "Request Marketing Developer Platform access"
        location: "Products tab -> Request Access to Marketing Developer Platform"
      - task: "Add OAuth 2.0 redirect URL"
        location: "Auth tab -> OAuth 2.0 settings -> Authorized redirect URLs: https://yourdomain.com/api/auth/social/linkedin/callback"
      - task: "Verify app has w_member_social scope"
        location: "Auth tab -> OAuth 2.0 scopes"

must_haves:
  truths:
    - "User can click Connect LinkedIn and complete OAuth flow"
    - "After OAuth, user's LinkedIn profile appears in connected accounts list"
    - "User can publish a post to their LinkedIn profile via the API"
    - "User can publish to LinkedIn Company Pages they admin (if authorized)"
  artifacts:
    - path: "lib/social/linkedin.ts"
      provides: "LinkedIn API client for OAuth and publishing"
      exports: ["getLinkedInAuthUrl", "exchangeLinkedInCode", "publishToLinkedIn"]
    - path: "app/api/auth/social/linkedin/route.ts"
      provides: "Initiates LinkedIn OAuth redirect"
      exports: ["GET"]
    - path: "app/api/auth/social/linkedin/callback/route.ts"
      provides: "Handles OAuth callback and stores tokens"
      exports: ["GET"]
    - path: "app/api/social/publish/linkedin/route.ts"
      provides: "Publishes content to LinkedIn"
      exports: ["POST"]
  key_links:
    - from: "app/api/auth/social/linkedin/route.ts"
      to: "lib/social/linkedin.ts"
      via: "getLinkedInAuthUrl call"
      pattern: "getLinkedInAuthUrl"
    - from: "app/api/auth/social/linkedin/callback/route.ts"
      to: "supabase.from('social_accounts')"
      via: "database insert"
      pattern: "from\\(['\"]social_accounts['\"]\\)"
    - from: "app/api/social/publish/linkedin/route.ts"
      to: "api.linkedin.com"
      via: "REST API POST request"
      pattern: "api\\.linkedin\\.com"
---

<objective>
Implement LinkedIn OAuth flow and post publishing via LinkedIn API.

Purpose: Enable users to connect their LinkedIn profile and company pages, then publish social media posts directly from DraggonnB.

Output: OAuth routes, LinkedIn API client library, and publish endpoint.
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Chris Terblanche\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-media-integration/05-01-SUMMARY.md
@lib/social/types.ts
@app/api/social/accounts/route.ts
@lib/social/facebook.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LinkedIn API client library</name>
  <files>
    lib/social/linkedin.ts
    .env.example
  </files>
  <action>
Create the LinkedIn API client. LinkedIn uses OAuth 2.0 and a REST API for posting.

**Key LinkedIn API endpoints:**
- OAuth: `https://www.linkedin.com/oauth/v2/authorization`
- Token exchange: `https://www.linkedin.com/oauth/v2/accessToken`
- User info: `https://api.linkedin.com/v2/userinfo` (OpenID Connect)
- Create post: `https://api.linkedin.com/v2/ugcPosts` (deprecated) or `https://api.linkedin.com/rest/posts` (new)

**Note:** LinkedIn has moved to a new API. The Marketing API uses `/rest/posts` endpoint. We'll use the newer versioned API.

```typescript
// lib/social/linkedin.ts

const LINKEDIN_AUTH_URL = 'https://www.linkedin.com/oauth/v2/authorization'
const LINKEDIN_TOKEN_URL = 'https://www.linkedin.com/oauth/v2/accessToken'
const LINKEDIN_API_URL = 'https://api.linkedin.com'

// Required scopes for posting
// openid and profile for user info, w_member_social for posting
const LINKEDIN_SCOPES = ['openid', 'profile', 'email', 'w_member_social'].join(' ')

interface LinkedInConfig {
  clientId: string
  clientSecret: string
  redirectUri: string
}

function getConfig(): LinkedInConfig {
  const clientId = process.env.LINKEDIN_CLIENT_ID
  const clientSecret = process.env.LINKEDIN_CLIENT_SECRET
  const redirectUri = `${process.env.NEXT_PUBLIC_APP_URL}/api/auth/social/linkedin/callback`

  if (!clientId || !clientSecret) {
    throw new Error('LinkedIn Client ID and Secret must be configured')
  }

  return { clientId, clientSecret, redirectUri }
}

/**
 * Generate LinkedIn OAuth authorization URL
 */
export function getLinkedInAuthUrl(state: string): string {
  const config = getConfig()
  const params = new URLSearchParams({
    response_type: 'code',
    client_id: config.clientId,
    redirect_uri: config.redirectUri,
    scope: LINKEDIN_SCOPES,
    state,
  })
  return `${LINKEDIN_AUTH_URL}?${params.toString()}`
}

/**
 * Exchange authorization code for access token
 */
export async function exchangeLinkedInCode(code: string): Promise<{
  access_token: string
  expires_in: number
  scope: string
}> {
  const config = getConfig()

  const response = await fetch(LINKEDIN_TOKEN_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      grant_type: 'authorization_code',
      code,
      redirect_uri: config.redirectUri,
      client_id: config.clientId,
      client_secret: config.clientSecret,
    }),
  })

  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error_description || error.error || 'Failed to exchange code')
  }

  return response.json()
}

/**
 * Get LinkedIn user profile using OpenID Connect userinfo endpoint
 */
export async function getLinkedInUser(accessToken: string): Promise<{
  sub: string // LinkedIn member ID (URN format)
  name: string
  given_name?: string
  family_name?: string
  picture?: string
  email?: string
}> {
  const response = await fetch(`${LINKEDIN_API_URL}/v2/userinfo`, {
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  })

  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.message || 'Failed to get user info')
  }

  return response.json()
}

/**
 * Publish a text post to LinkedIn (personal profile)
 * Uses the new Posts API (LinkedIn API v202304)
 */
export async function publishToLinkedIn(
  accessToken: string,
  authorUrn: string, // urn:li:person:{id} or urn:li:organization:{id}
  content: {
    text: string
    link?: string
  }
): Promise<{ id: string }> {
  // Build the post body according to LinkedIn Posts API spec
  const postBody: Record<string, unknown> = {
    author: authorUrn,
    commentary: content.text,
    visibility: 'PUBLIC',
    distribution: {
      feedDistribution: 'MAIN_FEED',
      targetEntities: [],
      thirdPartyDistributionChannels: [],
    },
    lifecycleState: 'PUBLISHED',
  }

  // Add article (link) if provided
  if (content.link) {
    postBody.content = {
      article: {
        source: content.link,
        title: content.text.substring(0, 100), // Use first 100 chars as title
      },
    }
  }

  const response = await fetch(`${LINKEDIN_API_URL}/rest/posts`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${accessToken}`,
      'Content-Type': 'application/json',
      'X-Restli-Protocol-Version': '2.0.0',
      'LinkedIn-Version': '202401', // Use recent API version
    },
    body: JSON.stringify(postBody),
  })

  if (!response.ok) {
    const errorText = await response.text()
    console.error('LinkedIn API error:', response.status, errorText)

    // Parse error if JSON
    try {
      const error = JSON.parse(errorText)
      throw new Error(error.message || error.error || `LinkedIn API error: ${response.status}`)
    } catch {
      throw new Error(`LinkedIn API error: ${response.status} - ${errorText}`)
    }
  }

  // LinkedIn returns the post ID in the x-restli-id header or response body
  const postId = response.headers.get('x-restli-id')

  if (postId) {
    return { id: postId }
  }

  // Try to get from body if header not present
  const data = await response.json().catch(() => ({}))
  return { id: data.id || 'unknown' }
}

/**
 * Convert LinkedIn sub (from userinfo) to URN format for posting
 * The sub from userinfo is the raw ID, we need to format it as URN
 */
export function formatLinkedInUrn(sub: string): string {
  // If already a URN, return as-is
  if (sub.startsWith('urn:li:')) {
    return sub
  }
  // Otherwise, format as person URN
  return `urn:li:person:${sub}`
}

/**
 * Get organizations (company pages) the user can post to
 * Requires r_organization_social scope
 */
export async function getLinkedInOrganizations(accessToken: string): Promise<Array<{
  id: string
  name: string
  vanityName?: string
}>> {
  // This requires additional permissions that may not be available
  // For MVP, we'll focus on personal profile posting
  // Organizations can be added later when Marketing API access is approved

  console.log('LinkedIn organization fetching not yet implemented')
  return []
}
```

**Update .env.example** - add LinkedIn credentials:

```
# LinkedIn API
LINKEDIN_CLIENT_ID=your_linkedin_client_id
LINKEDIN_CLIENT_SECRET=your_linkedin_client_secret
```
  </action>
  <verify>
- File `lib/social/linkedin.ts` exists with all exports
- `.env.example` has LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET
- `npm run build` passes (TypeScript compiles)
  </verify>
  <done>
- LinkedIn API client ready with OAuth, token exchange, and publish functions
- URN formatting helper for author identification
- Environment variables documented in .env.example
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LinkedIn OAuth routes</name>
  <files>
    app/api/auth/social/linkedin/route.ts
    app/api/auth/social/linkedin/callback/route.ts
  </files>
  <action>
Create OAuth initiation and callback routes following the same pattern as Facebook.

**OAuth initiation route:**

```typescript
// app/api/auth/social/linkedin/route.ts
import { NextResponse } from 'next/server'
import { cookies } from 'next/headers'
import { getLinkedInAuthUrl } from '@/lib/social/linkedin'
import { getUserOrg } from '@/lib/auth/get-user-org'

export async function GET() {
  try {
    // Verify user is authenticated
    const { data: userOrg, error } = await getUserOrg()
    if (error || !userOrg) {
      return NextResponse.redirect(new URL('/login', process.env.NEXT_PUBLIC_APP_URL))
    }

    // Generate state for CSRF protection
    const state = crypto.randomUUID()

    // Store state in cookie for verification in callback
    const cookieStore = await cookies()
    cookieStore.set('li_oauth_state', state, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 600, // 10 minutes
      path: '/',
    })

    // Redirect to LinkedIn OAuth
    const authUrl = getLinkedInAuthUrl(state)
    return NextResponse.redirect(authUrl)
  } catch (error) {
    console.error('LinkedIn OAuth init error:', error)
    return NextResponse.redirect(
      new URL('/settings/social?error=oauth_init_failed', process.env.NEXT_PUBLIC_APP_URL)
    )
  }
}
```

**OAuth callback route:**

```typescript
// app/api/auth/social/linkedin/callback/route.ts
import { NextResponse } from 'next/server'
import { cookies } from 'next/headers'
import {
  exchangeLinkedInCode,
  getLinkedInUser,
  formatLinkedInUrn,
} from '@/lib/social/linkedin'
import { getUserOrg } from '@/lib/auth/get-user-org'
import { createClient } from '@/lib/supabase/server'

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const code = searchParams.get('code')
  const state = searchParams.get('state')
  const errorParam = searchParams.get('error')
  const errorDescription = searchParams.get('error_description')

  const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'
  const settingsUrl = `${baseUrl}/settings/social`

  // Handle OAuth errors
  if (errorParam) {
    console.error('LinkedIn OAuth error:', errorParam, errorDescription)
    return NextResponse.redirect(`${settingsUrl}?error=linkedin_denied`)
  }

  if (!code || !state) {
    return NextResponse.redirect(`${settingsUrl}?error=missing_params`)
  }

  try {
    // Verify state for CSRF protection
    const cookieStore = await cookies()
    const storedState = cookieStore.get('li_oauth_state')?.value
    cookieStore.delete('li_oauth_state')

    if (state !== storedState) {
      console.error('State mismatch:', { received: state, stored: storedState })
      return NextResponse.redirect(`${settingsUrl}?error=invalid_state`)
    }

    // Verify user is authenticated
    const { data: userOrg, error: authError } = await getUserOrg()
    if (authError || !userOrg) {
      return NextResponse.redirect(`${baseUrl}/login`)
    }

    // Exchange code for token
    const tokenData = await exchangeLinkedInCode(code)

    // Get user info
    const liUser = await getLinkedInUser(tokenData.access_token)

    // Calculate token expiry
    const expiresAt = new Date()
    expiresAt.setSeconds(expiresAt.getSeconds() + tokenData.expires_in)

    // Format the author URN for posting
    const authorUrn = formatLinkedInUrn(liUser.sub)

    // Save to social_accounts
    const supabase = await createClient()
    const { error: saveError } = await supabase.from('social_accounts').upsert({
      organization_id: userOrg.organizationId,
      platform: 'linkedin',
      platform_user_id: liUser.sub,
      platform_username: liUser.email,
      platform_display_name: liUser.name,
      profile_image_url: liUser.picture,
      access_token: tokenData.access_token,
      token_expires_at: expiresAt.toISOString(),
      // Store the URN in page_id field for easy access when posting
      page_id: authorUrn,
      scopes: tokenData.scope.split(' '),
      status: 'active',
      connected_at: new Date().toISOString(),
      created_by: userOrg.userId,
    }, {
      onConflict: 'organization_id,platform,platform_user_id'
    })

    if (saveError) {
      console.error('Error saving LinkedIn account:', saveError)
      return NextResponse.redirect(`${settingsUrl}?error=save_failed`)
    }

    return NextResponse.redirect(`${settingsUrl}?success=linkedin_connected`)
  } catch (error) {
    console.error('LinkedIn OAuth callback error:', error)
    return NextResponse.redirect(`${settingsUrl}?error=callback_failed`)
  }
}
```
  </action>
  <verify>
- Files exist at app/api/auth/social/linkedin/route.ts and callback/route.ts
- `npm run build` passes
- OAuth flow preserves state in cookie for CSRF protection
  </verify>
  <done>
- GET /api/auth/social/linkedin redirects to LinkedIn OAuth
- GET /api/auth/social/linkedin/callback handles token exchange and saves account
- CSRF protection via state parameter
- User URN stored for posting
  </done>
</task>

<task type="auto">
  <name>Task 3: Create LinkedIn publish endpoint</name>
  <files>
    app/api/social/publish/linkedin/route.ts
  </files>
  <action>
Create the publish endpoint for LinkedIn posts.

```typescript
// app/api/social/publish/linkedin/route.ts
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { getUserOrg } from '@/lib/auth/get-user-org'
import { publishToLinkedIn } from '@/lib/social/linkedin'

interface PublishRequest {
  account_id: string
  content: string
  link_url?: string
}

export async function POST(request: Request) {
  try {
    const { data: userOrg, error: authError } = await getUserOrg()
    if (authError || !userOrg) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const body: PublishRequest = await request.json()

    if (!body.account_id || !body.content) {
      return NextResponse.json(
        { error: 'account_id and content are required' },
        { status: 400 }
      )
    }

    // LinkedIn has a 3000 character limit for posts
    if (body.content.length > 3000) {
      return NextResponse.json(
        { error: 'Content exceeds LinkedIn 3000 character limit' },
        { status: 400 }
      )
    }

    const supabase = await createClient()

    // Get the social account
    const { data: account, error: fetchError } = await supabase
      .from('social_accounts')
      .select('*')
      .eq('id', body.account_id)
      .eq('organization_id', userOrg.organizationId)
      .single()

    if (fetchError || !account) {
      return NextResponse.json({ error: 'Account not found' }, { status: 404 })
    }

    if (account.platform !== 'linkedin') {
      return NextResponse.json(
        { error: 'This endpoint only supports LinkedIn accounts' },
        { status: 400 }
      )
    }

    if (account.status !== 'active') {
      return NextResponse.json(
        { error: `Account is ${account.status}. Please reconnect.` },
        { status: 400 }
      )
    }

    // Check token expiry
    if (account.token_expires_at && new Date(account.token_expires_at) < new Date()) {
      // Mark as expired
      await supabase
        .from('social_accounts')
        .update({ status: 'expired', error_message: 'Token expired' })
        .eq('id', account.id)

      return NextResponse.json(
        { error: 'Token expired. Please reconnect your account.' },
        { status: 401 }
      )
    }

    // Get author URN from page_id field
    const authorUrn = account.page_id
    if (!authorUrn) {
      return NextResponse.json(
        { error: 'Account missing author URN. Please reconnect.' },
        { status: 400 }
      )
    }

    // Publish to LinkedIn
    const result = await publishToLinkedIn(
      account.access_token,
      authorUrn,
      {
        text: body.content,
        link: body.link_url,
      }
    )

    // Update last_used_at
    await supabase
      .from('social_accounts')
      .update({ last_used_at: new Date().toISOString() })
      .eq('id', account.id)

    return NextResponse.json({
      success: true,
      platform: 'linkedin',
      platform_post_id: result.id,
    })
  } catch (error) {
    console.error('LinkedIn publish error:', error)

    const message = error instanceof Error ? error.message : 'Failed to publish'

    // Check for common LinkedIn API errors
    if (message.includes('401') || message.includes('Unauthorized')) {
      return NextResponse.json(
        { error: 'LinkedIn authorization failed. Please reconnect your account.' },
        { status: 401 }
      )
    }

    if (message.includes('403') || message.includes('Forbidden')) {
      return NextResponse.json(
        { error: 'LinkedIn permission denied. Your app may need additional access.' },
        { status: 403 }
      )
    }

    return NextResponse.json({ error: message }, { status: 500 })
  }
}
```
  </action>
  <verify>
- File exists at app/api/social/publish/linkedin/route.ts
- `npm run build` passes
- POST endpoint validates account ownership and platform before publishing
  </verify>
  <done>
- POST /api/social/publish/linkedin publishes to LinkedIn profile
- Character limit (3000) enforced
- Token expiry checked and account marked as expired if needed
- Helpful error messages for common API failures
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>LinkedIn OAuth flow and publish API</what-built>
  <how-to-verify>
1. Ensure you have configured LinkedIn App credentials:
   - LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET in .env.local
   - OAuth redirect URI configured in LinkedIn Developer Console
   - App has w_member_social scope

2. Ensure migration (04_social_accounts.sql) was run in Supabase

3. Start dev server: `npm run dev`

4. Navigate to http://localhost:3000/settings/social

5. Click "Connect LinkedIn" from the dropdown and complete OAuth flow
   - You should be redirected to LinkedIn login
   - After authorizing, you should be redirected back
   - Your LinkedIn profile should appear in the connected accounts list

6. Test publish (requires valid LinkedIn app with posting permissions):
   ```bash
   curl -X POST http://localhost:3000/api/social/publish/linkedin \
     -H "Content-Type: application/json" \
     -d '{"account_id": "YOUR_ACCOUNT_ID", "content": "Test post from DraggonnB!"}'
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if OAuth flow and account display work, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. LinkedIn OAuth redirect works (even without valid credentials, redirect should happen)
3. Callback route handles state verification
4. Publish endpoint validates inputs and checks account ownership
</verification>

<success_criteria>
- [ ] lib/social/linkedin.ts exports OAuth and publish functions
- [ ] .env.example documents LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET
- [ ] GET /api/auth/social/linkedin redirects to LinkedIn
- [ ] GET /api/auth/social/linkedin/callback saves account after OAuth
- [ ] POST /api/social/publish/linkedin publishes to LinkedIn
- [ ] 3000 character limit enforced
- [ ] Token expiry is checked before publishing
- [ ] npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-media-integration/05-03-SUMMARY.md`
</output>
