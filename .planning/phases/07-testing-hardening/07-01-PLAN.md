---
phase: 07-testing-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - vitest.setup.ts
  - package.json
  - __tests__/unit/lib/payments/payfast.test.ts
  - __tests__/fixtures/payfast-vectors.ts
autonomous: true

must_haves:
  truths:
    - "Running npm test executes Vitest without configuration errors"
    - "PayFast signature with known inputs produces expected MD5 hash"
    - "Invalid PayFast signature is rejected by validatePayFastSignature"
    - "Valid PayFast signature is accepted by validatePayFastSignature"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration for Next.js 14 App Router"
      contains: "defineConfig"
    - path: "vitest.setup.ts"
      provides: "Test environment setup with env var loading"
      contains: "loadEnvConfig"
    - path: "__tests__/unit/lib/payments/payfast.test.ts"
      provides: "PayFast signature unit tests"
      min_lines: 50
    - path: "__tests__/fixtures/payfast-vectors.ts"
      provides: "Known test vectors for PayFast signatures"
      exports: ["PAYFAST_TEST_VECTORS"]
  key_links:
    - from: "vitest.config.ts"
      to: "vitest.setup.ts"
      via: "setupFiles reference"
      pattern: "setupFiles.*vitest\\.setup"
    - from: "__tests__/unit/lib/payments/payfast.test.ts"
      to: "lib/payments/payfast.ts"
      via: "import statements"
      pattern: "import.*from.*@/lib/payments/payfast"
---

<objective>
Set up Vitest test framework and create PayFast signature validation unit tests

Purpose: Establish test infrastructure for the project and ensure PayFast payment signature validation has automated tests with known test vectors, preventing silent regressions in payment security.

Output: Working Vitest configuration, test setup file, PayFast signature unit tests with test vectors
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris Terblanche\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-testing-hardening/07-RESEARCH.md
@lib/payments/payfast.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Vitest for Next.js 14 App Router</name>
  <files>
    - vitest.config.ts
    - vitest.setup.ts
    - package.json
    - __tests__/fixtures/.gitkeep
  </files>
  <action>
1. Install testing dependencies:
   ```bash
   npm install -D vitest @vitejs/plugin-react jsdom @testing-library/react @testing-library/dom vite-tsconfig-paths next-test-api-route-handler @testing-library/jest-dom
   ```

2. Create `vitest.config.ts` at project root:
   - Use `defineConfig` from vitest/config
   - Add plugins: `tsconfigPaths()` for @/ imports, `react()` for JSX
   - Set default environment to 'jsdom' for component tests
   - Configure environmentMatchGlobs:
     - `['**/__tests__/integration/api/**', 'node']` - API tests use Node
     - `['**/__tests__/unit/lib/**', 'node']` - Server utilities use Node
   - Set setupFiles to ['./vitest.setup.ts']
   - Configure coverage: provider 'v8', include ['lib/**', 'app/api/**']
   - Load env config at top of file using `loadEnvConfig(process.cwd())`

3. Create `vitest.setup.ts` at project root:
   - Import `loadEnvConfig` from '@next/env'
   - Import '@testing-library/jest-dom/vitest' for DOM matchers
   - Call `loadEnvConfig(process.cwd())` to load .env files
   - Add `beforeEach(() => { vi.clearAllMocks() })` to reset mocks

4. Update `package.json` scripts:
   - Add "test": "vitest"
   - Add "test:ui": "vitest --ui"
   - Add "test:coverage": "vitest --coverage"
   - Add "test:unit": "vitest __tests__/unit"
   - Add "test:integration": "vitest __tests__/integration"

5. Create directory structure:
   - `__tests__/unit/lib/payments/` (for PayFast tests)
   - `__tests__/integration/api/` (for API tests)
   - `__tests__/integration/middleware/` (for middleware tests)
   - `__tests__/fixtures/` (for test data)

6. Create `__tests__/fixtures/.gitkeep` to ensure directory is tracked
  </action>
  <verify>
Run `npm test -- --run` and verify Vitest starts without configuration errors (no tests yet is OK)
  </verify>
  <done>
Vitest configuration complete: vitest.config.ts exists with correct plugins and environment settings, vitest.setup.ts loads env vars, package.json has test scripts, directory structure created
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PayFast signature unit tests with known test vectors</name>
  <files>
    - __tests__/fixtures/payfast-vectors.ts
    - __tests__/unit/lib/payments/payfast.test.ts
  </files>
  <action>
1. Create `__tests__/fixtures/payfast-vectors.ts`:
   - Export `PAYFAST_TEST_VECTORS` object with test cases
   - Each test case has: input (form data object), expectedSignature, passphrase (optional)
   - Generate test vectors by manually computing MD5 hashes:

     Test Vector 1 (without passphrase):
     ```
     Input fields (sorted alphabetically):
     amount=1500.00
     item_name=DraggonnB+CRMM+-+Starter+Plan
     merchant_id=10000100
     merchant_key=46f0cd694581a

     String to hash: "amount=1500.00&item_name=DraggonnB+CRMM+-+Starter+Plan&merchant_id=10000100&merchant_key=46f0cd694581a"
     ```
     Compute MD5 of this string to get expected signature

     Test Vector 2 (with passphrase):
     Same fields but append "&passphrase=testpassphrase" before hashing

     Test Vector 3 (ITN validation):
     Typical ITN payload fields with computed signature

   - IMPORTANT: Use Node crypto to pre-compute the expected signatures:
     ```typescript
     import crypto from 'crypto'
     const hash = crypto.createHash('md5').update(paramString).digest('hex')
     ```

2. Create `__tests__/unit/lib/payments/payfast.test.ts`:
   - Add `/** @vitest-environment node */` at top (PayFast uses Node crypto)
   - Import `describe, it, expect, vi` from 'vitest'
   - Import `generatePayFastSignature, validatePayFastSignature` from '@/lib/payments/payfast'
   - Import `PAYFAST_TEST_VECTORS` from fixtures

   Test cases for generatePayFastSignature:
   - "generates correct MD5 signature without passphrase"
   - "generates correct MD5 signature with passphrase"
   - "excludes signature field from hash calculation"
   - "handles special characters in values (URL encoding)"

   Test cases for validatePayFastSignature:
   - "returns true for valid signature"
   - "returns false for invalid signature"
   - "returns false when signature is missing"
   - "handles passphrase in validation"

   Test structure example:
   ```typescript
   describe('PayFast signature validation', () => {
     describe('generatePayFastSignature', () => {
       it('generates correct MD5 signature without passphrase', () => {
         const { input, expectedSignature } = PAYFAST_TEST_VECTORS.withoutPassphrase
         const signature = generatePayFastSignature(input)
         expect(signature).toBe(expectedSignature)
       })
     })

     describe('validatePayFastSignature', () => {
       it('returns true for valid signature', () => {
         const { input, expectedSignature } = PAYFAST_TEST_VECTORS.withoutPassphrase
         const dataWithSignature = { ...input, signature: expectedSignature }
         expect(validatePayFastSignature(dataWithSignature)).toBe(true)
       })

       it('returns false for invalid signature', () => {
         const { input } = PAYFAST_TEST_VECTORS.withoutPassphrase
         const dataWithBadSignature = { ...input, signature: 'invalid' }
         expect(validatePayFastSignature(dataWithBadSignature)).toBe(false)
       })
     })
   })
   ```
  </action>
  <verify>
Run `npm test -- --run __tests__/unit/lib/payments/payfast.test.ts` - all PayFast signature tests pass
  </verify>
  <done>
PayFast signature tests complete: 8+ test cases pass, test vectors verified with known MD5 hashes, both generatePayFastSignature and validatePayFastSignature have coverage
  </done>
</task>

</tasks>

<verification>
1. `npm test -- --run` exits with code 0 (all tests pass)
2. `npm run test:unit` runs only unit tests without errors
3. PayFast tests verify both signature generation and validation
4. Test vectors are independently verifiable (MD5 hashes can be checked)
</verification>

<success_criteria>
- TEST-01 satisfied: PayFast signature validation has unit tests with known test vectors
- Vitest runs without configuration errors
- All PayFast signature tests pass
- Test framework ready for additional tests (07-02)
</success_criteria>

<output>
After completion, create `.planning/phases/07-testing-hardening/07-01-SUMMARY.md`
</output>
