---
phase: 07-testing-hardening
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - __tests__/integration/middleware/auth-middleware.test.ts
  - __tests__/integration/api/crm/contacts.test.ts
  - __tests__/fixtures/supabase-mocks.ts
autonomous: true

must_haves:
  truths:
    - "Unauthenticated request to /dashboard returns redirect to /login"
    - "Authenticated request to /dashboard is allowed through"
    - "Unauthenticated request to CRM contacts API returns 401"
    - "Authenticated request to CRM contacts API returns contacts list"
    - "CRM contact creation with valid data returns 201"
    - "CRM contact creation without required fields returns 400"
  artifacts:
    - path: "__tests__/integration/middleware/auth-middleware.test.ts"
      provides: "Auth middleware tests for protected routes"
      min_lines: 50
    - path: "__tests__/integration/api/crm/contacts.test.ts"
      provides: "CRM contacts API CRUD tests"
      min_lines: 80
    - path: "__tests__/fixtures/supabase-mocks.ts"
      provides: "Reusable Supabase client mocks"
      exports: ["createMockSupabaseClient"]
  key_links:
    - from: "__tests__/integration/middleware/auth-middleware.test.ts"
      to: "lib/supabase/middleware.ts"
      via: "import updateSession"
      pattern: "import.*updateSession.*from.*@/lib/supabase/middleware"
    - from: "__tests__/integration/api/crm/contacts.test.ts"
      to: "app/api/crm/contacts/route.ts"
      via: "import route handlers"
      pattern: "import.*from.*@/app/api/crm/contacts/route"
---

<objective>
Create auth middleware tests and CRM API integration tests

Purpose: Ensure auth middleware correctly protects routes (redirecting unauthenticated users) and CRM API correctly handles CRUD operations with proper authentication checks, preventing regressions in access control.

Output: Auth middleware tests, CRM contacts API tests, reusable Supabase mock utilities
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Chris Terblanche\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-testing-hardening/07-RESEARCH.md
@.planning/phases/07-testing-hardening/07-01-SUMMARY.md
@lib/supabase/middleware.ts
@app/api/crm/contacts/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase mock utilities and auth middleware tests</name>
  <files>
    - __tests__/fixtures/supabase-mocks.ts
    - __tests__/integration/middleware/auth-middleware.test.ts
  </files>
  <action>
1. Create `__tests__/fixtures/supabase-mocks.ts`:
   - Import `vi` from 'vitest'
   - Export `createMockSupabaseClient(overrides = {})` function that returns a mock client
   - Mock structure must support Supabase's chaining API:
     ```typescript
     {
       auth: {
         getUser: vi.fn(() => ({
           data: { user: { id: 'test-user-id', email: 'test@example.com' } },
           error: null,
         })),
       },
       from: vi.fn((table: string) => ({
         select: vi.fn(() => ({
           eq: vi.fn(() => ({
             single: vi.fn(() => ({
               data: { id: 'test-id', organization_id: 'test-org-id' },
               error: null,
             })),
           })),
           order: vi.fn(() => ({
             range: vi.fn(() => ({
               data: [],
               error: null,
               count: 0,
             })),
           })),
         })),
         insert: vi.fn(() => ({
           select: vi.fn(() => ({
             single: vi.fn(() => ({
               data: { id: 'new-id' },
               error: null,
             })),
           })),
         })),
       })),
     }
     ```
   - Export `mockUnauthenticatedUser()` helper that returns error
   - Export `mockAuthenticatedUser(userId, email)` helper

2. Create `__tests__/integration/middleware/auth-middleware.test.ts`:
   - Add `/** @vitest-environment node */` at top (middleware runs in Node/Edge)
   - Import `describe, it, expect, vi, beforeEach` from 'vitest'
   - Import `NextRequest` from 'next/server'
   - Import `updateSession` from '@/lib/supabase/middleware'

   Mock Supabase SSR:
   ```typescript
   vi.mock('@supabase/ssr', () => ({
     createServerClient: vi.fn((url, key, options) => mockSupabaseClient),
   }))
   ```

   Test cases:
   - "redirects to login when accessing /dashboard without auth"
   - "redirects to login when accessing /crm without auth"
   - "redirects to login when accessing /email without auth"
   - "redirects to login when accessing /content-generator without auth"
   - "allows access to /dashboard when authenticated"
   - "redirects authenticated users away from /login to /dashboard"
   - "allows unauthenticated access to public routes"

   Test structure:
   ```typescript
   describe('Auth Middleware', () => {
     beforeEach(() => {
       vi.clearAllMocks()
     })

     describe('protected routes without auth', () => {
       it('redirects to login when accessing /dashboard without auth', async () => {
         // Mock unauthenticated user
         const { createServerClient } = await import('@supabase/ssr')
         vi.mocked(createServerClient).mockReturnValue({
           auth: {
             getUser: vi.fn(() => ({
               data: { user: null },
               error: new Error('Not authenticated'),
             })),
           },
         } as any)

         const request = new NextRequest('http://localhost:3000/dashboard')
         const response = await updateSession(request)

         expect(response.status).toBe(307) // Redirect status
         expect(response.headers.get('location')).toContain('/login')
       })
     })

     describe('protected routes with auth', () => {
       it('allows access to /dashboard when authenticated', async () => {
         // Mock authenticated user
         const { createServerClient } = await import('@supabase/ssr')
         vi.mocked(createServerClient).mockReturnValue({
           auth: {
             getUser: vi.fn(() => ({
               data: { user: { id: 'test-user', email: 'test@example.com' } },
               error: null,
             })),
           },
         } as any)

         const request = new NextRequest('http://localhost:3000/dashboard')
         const response = await updateSession(request)

         expect(response.status).toBe(200)
       })
     })
   })
   ```
  </action>
  <verify>
Run `npm test -- --run __tests__/integration/middleware/auth-middleware.test.ts` - all auth middleware tests pass
  </verify>
  <done>
Auth middleware tests complete: Protected routes correctly redirect unauthenticated users to /login, authenticated users can access protected routes, auth routes redirect authenticated users to dashboard
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CRM contacts API integration tests</name>
  <files>
    - __tests__/integration/api/crm/contacts.test.ts
  </files>
  <action>
1. Create `__tests__/integration/api/crm/contacts.test.ts`:
   - Add `/** @vitest-environment node */` at top (API routes run in Node)
   - Import `describe, it, expect, vi, beforeEach` from 'vitest'
   - Import `testApiHandler` from 'next-test-api-route-handler'
   - Import `* as contactsRoute` from '@/app/api/crm/contacts/route'
   - Import mock utilities from fixtures

   Mock Supabase server client:
   ```typescript
   vi.mock('@/lib/supabase/server', () => ({
     createClient: vi.fn(),
   }))
   ```

   Test cases for GET /api/crm/contacts:
   - "returns 401 when user is not authenticated"
   - "returns 400 when user has no organization"
   - "returns empty contacts list for new organization"
   - "returns contacts list with pagination info"

   Test cases for POST /api/crm/contacts:
   - "returns 401 when user is not authenticated"
   - "returns 400 when first_name is missing"
   - "returns 400 when email is missing"
   - "returns 201 and creates contact with valid data"
   - "returns 409 when email already exists"

   Test structure:
   ```typescript
   describe('CRM Contacts API', () => {
     beforeEach(() => {
       vi.clearAllMocks()
     })

     describe('GET /api/crm/contacts', () => {
       it('returns 401 when user is not authenticated', async () => {
         const { createClient } = await import('@/lib/supabase/server')
         vi.mocked(createClient).mockResolvedValue({
           auth: {
             getUser: vi.fn(() => ({
               data: { user: null },
               error: new Error('Not authenticated'),
             })),
           },
         } as any)

         await testApiHandler({
           appHandler: contactsRoute,
           test: async ({ fetch }) => {
             const response = await fetch({ method: 'GET' })
             expect(response.status).toBe(401)
           },
         })
       })

       it('returns contacts list with pagination info', async () => {
         const { createClient } = await import('@/lib/supabase/server')
         vi.mocked(createClient).mockResolvedValue({
           auth: {
             getUser: vi.fn(() => ({
               data: { user: { id: 'test-user-id' } },
               error: null,
             })),
           },
           from: vi.fn((table) => {
             if (table === 'users') {
               return {
                 select: vi.fn(() => ({
                   eq: vi.fn(() => ({
                     single: vi.fn(() => ({
                       data: { organization_id: 'test-org-id' },
                       error: null,
                     })),
                   })),
                 })),
               }
             }
             if (table === 'contacts') {
               return {
                 select: vi.fn(() => ({
                   eq: vi.fn(() => ({
                     order: vi.fn(() => ({
                       range: vi.fn(() => ({
                         or: vi.fn(() => ({
                           data: [
                             { id: '1', first_name: 'John', email: 'john@example.com' },
                           ],
                           error: null,
                           count: 1,
                         })),
                         data: [
                           { id: '1', first_name: 'John', email: 'john@example.com' },
                         ],
                         error: null,
                         count: 1,
                       })),
                     })),
                   })),
                 })),
               }
             }
           }),
         } as any)

         await testApiHandler({
           appHandler: contactsRoute,
           test: async ({ fetch }) => {
             const response = await fetch({ method: 'GET' })
             expect(response.status).toBe(200)
             const data = await response.json()
             expect(data.contacts).toBeDefined()
             expect(data.total).toBeDefined()
             expect(data.limit).toBeDefined()
           },
         })
       })
     })

     describe('POST /api/crm/contacts', () => {
       it('returns 400 when first_name is missing', async () => {
         const { createClient } = await import('@/lib/supabase/server')
         vi.mocked(createClient).mockResolvedValue({
           auth: {
             getUser: vi.fn(() => ({
               data: { user: { id: 'test-user-id' } },
               error: null,
             })),
           },
           from: vi.fn(() => ({
             select: vi.fn(() => ({
               eq: vi.fn(() => ({
                 single: vi.fn(() => ({
                   data: { organization_id: 'test-org-id' },
                   error: null,
                 })),
               })),
             })),
           })),
         } as any)

         await testApiHandler({
           appHandler: contactsRoute,
           test: async ({ fetch }) => {
             const response = await fetch({
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ email: 'test@example.com' }), // Missing first_name
             })
             expect(response.status).toBe(400)
           },
         })
       })

       it('returns 201 and creates contact with valid data', async () => {
         const { createClient } = await import('@/lib/supabase/server')
         vi.mocked(createClient).mockResolvedValue({
           auth: {
             getUser: vi.fn(() => ({
               data: { user: { id: 'test-user-id' } },
               error: null,
             })),
           },
           from: vi.fn((table) => {
             if (table === 'users') {
               return {
                 select: vi.fn(() => ({
                   eq: vi.fn(() => ({
                     single: vi.fn(() => ({
                       data: { organization_id: 'test-org-id' },
                       error: null,
                     })),
                   })),
                 })),
               }
             }
             if (table === 'contacts') {
               return {
                 insert: vi.fn(() => ({
                   select: vi.fn(() => ({
                     single: vi.fn(() => ({
                       data: {
                         id: 'new-contact-id',
                         first_name: 'John',
                         email: 'john@example.com',
                       },
                       error: null,
                     })),
                   })),
                 })),
               }
             }
           }),
         } as any)

         await testApiHandler({
           appHandler: contactsRoute,
           test: async ({ fetch }) => {
             const response = await fetch({
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                 first_name: 'John',
                 last_name: 'Doe',
                 email: 'john@example.com',
               }),
             })
             expect(response.status).toBe(201)
             const data = await response.json()
             expect(data.contact).toBeDefined()
             expect(data.contact.first_name).toBe('John')
           },
         })
       })
     })
   })
   ```

Note: The signup flow integration test (TEST-02) is implicitly covered by these tests. The CRM API tests verify that:
- Users without organization_id get 400 (verifies org linkage is checked)
- Users with organization_id can access their org's data (verifies linkage works)
The actual signup-to-org-creation flow is handled by Supabase Auth + database triggers, which are tested via RLS in production.
  </action>
  <verify>
Run `npm test -- --run __tests__/integration/api/crm/contacts.test.ts` - all CRM tests pass
  </verify>
  <done>
CRM API tests complete: Unauthenticated requests return 401, missing org returns 400, valid CRUD operations work, validation enforced for required fields
  </done>
</task>

</tasks>

<verification>
1. `npm test -- --run` exits with code 0 (all tests pass)
2. `npm run test:integration` runs all integration tests without errors
3. Auth middleware tests verify protected route behavior
4. CRM API tests verify CRUD operations and authentication
5. All tests use mocked Supabase client (no real database calls)
</verification>

<success_criteria>
- TEST-02 partially satisfied: CRM tests verify user-org linkage is checked on every request
- TEST-03 satisfied: CRM contact CRUD operations pass basic API tests
- TEST-04 satisfied: Auth middleware tests confirm unauthenticated requests return redirect
- All tests pass with mocked dependencies
- Supabase mock utilities are reusable for future tests
</success_criteria>

<output>
After completion, create `.planning/phases/07-testing-hardening/07-02-SUMMARY.md`
</output>
