---
phase: 04-n8n-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .env.example
  - lib/n8n/webhooks.ts
autonomous: false

user_setup:
  - service: n8n
    why: "Workflow automation credentials"
    env_vars: []
    dashboard_config:
      - task: "Add Anthropic API Key credential"
        location: "N8N UI -> Settings -> Credentials -> Add Credential -> Header Auth"
        details: "Name: 'Anthropic API Key', Header Name: 'x-api-key', Header Value: your Anthropic API key"
      - task: "Add Supabase Service Role credential"
        location: "N8N UI -> Settings -> Credentials -> Add Credential -> Header Auth"
        details: "Name: 'Supabase Service Role', Header Name: 'apikey', Header Value: your Supabase service role key"
      - task: "Assign credentials to workflow nodes"
        location: "N8N UI -> DraggonnB workflows -> Edit each node using credentials"
        details: "Claude AI Generate uses Anthropic credential, Supabase nodes use Supabase Service Role credential"
      - task: "Publish all three DraggonnB workflows"
        location: "N8N UI -> Each workflow -> Publish button"

must_haves:
  truths:
    - "N8N workflows have valid credentials assigned"
    - "Content generator webhook responds to test request"
    - "Queue processor workflow is active and scheduled"
    - "Analytics collector workflow is active and scheduled"
  artifacts:
    - path: ".env.example"
      provides: "N8N environment variable documentation"
      contains: "N8N_WEBHOOK_CONTENT_GENERATOR"
    - path: "lib/n8n/webhooks.ts"
      provides: "N8N webhook client with correct URLs"
      contains: "draggonnb-generate-content"
  key_links:
    - from: "app/api/content/generate/route.ts"
      to: "N8N webhook"
      via: "fetch call to N8N_BASE_URL"
      pattern: "N8N_BASE_URL.*webhook"
---

<objective>
Configure N8N credentials and verify all three DraggonnB workflows are active and responding.

Purpose: N8N workflows are deployed but inactive. Without credentials, the AI Content Generator cannot call Anthropic, and all workflows cannot access Supabase. This plan ensures credentials are properly configured and workflows are published.

Output: All three DraggonnB workflows active in N8N, content generation webhook responding to test requests.
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris Terblanche\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-n8n-automation/04-RESEARCH.md

@lib/n8n/webhooks.ts
@app/api/content/generate/route.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update webhook URLs to match deployed workflow paths</name>
  <files>lib/n8n/webhooks.ts, .env.example</files>
  <action>
Update the N8N webhook client to use the correct production webhook path.

In lib/n8n/webhooks.ts:
1. The triggerContentGeneration function currently uses `process.env.N8N_WEBHOOK_CONTENT_GENERATOR`
2. Verify this matches the deployed workflow path: `/webhook/generate-content` (not `/webhook/draggonnb-generate-content`)
3. Update if needed to ensure consistency

In .env.example:
1. Update N8N_WEBHOOK_CONTENT_GENERATOR to `/webhook/generate-content` if different
2. Add comment noting this is the production webhook URL (not test URL)
3. Ensure N8N_BASE_URL points to https://n8n.srv1114684.hstgr.cloud

Why: The deployed workflow in scripts/deploy-n8n-workflows.py uses path "generate-content", so the webhook URL is /webhook/generate-content. The env example must match.
  </action>
  <verify>
grep "generate-content" lib/n8n/webhooks.ts
grep "N8N_WEBHOOK_CONTENT_GENERATOR" .env.example
npm run build
  </verify>
  <done>
Webhook URLs in code match deployed N8N workflow paths. Build passes.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure N8N credentials and publish workflows</name>
  <action>
User must configure credentials in N8N UI and publish workflows. Claude cannot do this because N8N credential values (API keys) must come from user's accounts.
  </action>
  <instructions>
Complete these steps in the N8N UI at https://n8n.srv1114684.hstgr.cloud:

**Step 1: Create Anthropic API Key Credential**
1. Go to Settings (gear icon) -> Credentials
2. Click "Add Credential"
3. Search for "Header Auth" and select it
4. Configure:
   - Name: `Anthropic API Key`
   - Header Name: `x-api-key`
   - Header Value: [Your Anthropic API key from https://console.anthropic.com/]
5. Save

**Step 2: Create Supabase Service Role Credential**
1. Click "Add Credential" again
2. Search for "Header Auth" and select it
3. Configure:
   - Name: `Supabase Service Role`
   - Header Name: `apikey`
   - Header Value: [Your Supabase service role key from https://supabase.com/dashboard/project/psqfgzbjbgqrmjskdavs/settings/api]
5. Save

**Step 3: Assign Credentials to DraggonnB - AI Content Generator**
1. Open "DraggonnB - AI Content Generator" workflow
2. Click "Claude AI Generate" node
3. Under Authentication, select "Anthropic API Key" credential
4. Click "Save to Supabase" node
5. Under Authentication, select "Supabase Service Role" credential
6. Click Save (top right)
7. Click **Publish** (important: not just Save)

**Step 4: Assign Credentials to DraggonnB - Content Queue Processor**
1. Open "DraggonnB - Content Queue Processor" workflow
2. Click "Fetch Due Posts" node -> select "Supabase Service Role" credential
3. Click "Mark as Published" node -> select "Supabase Service Role" credential
4. Save and **Publish**

**Step 5: Assign Credentials to DraggonnB - Analytics Collector**
1. Open "DraggonnB - Analytics Collector" workflow
2. Click "Fetch Recent Posts" node -> select "Supabase Service Role" credential
3. Click "Save Analytics Snapshot" node -> select "Supabase Service Role" credential
4. Save and **Publish**

**Step 6: Verify All Workflows Active**
1. Go to Workflows list
2. Confirm all three DraggonnB workflows show "Active" badge
  </instructions>
  <resume-signal>Type "credentials configured" when all three workflows are published and active, or describe any issues encountered.</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Test content generation webhook end-to-end</name>
  <files>(no files modified - verification only)</files>
  <action>
Test the N8N webhook by sending a test request via curl. This verifies:
1. Webhook URL is correct
2. Anthropic credential is working
3. Supabase save is working
4. Response format matches what the app expects

Run this curl command (or equivalent fetch in Node):
```bash
curl -X POST "https://n8n.srv1114684.hstgr.cloud/webhook/generate-content" \
  -H "Content-Type: application/json" \
  -d '{
    "organizationId": "test-org-123",
    "prompt": "Benefits of cloud automation for South African SMEs",
    "platforms": ["linkedin"],
    "tone": "professional",
    "contentType": "post"
  }'
```

Expected response format:
```json
{
  "success": true,
  "data": {
    "content": "...",
    "post_id": "..."
  }
}
```

If the webhook returns an error, check N8N Executions tab for detailed error logs.

Note: This will create a draft post in Supabase social_posts table with organization_id "test-org-123". This test data can be deleted later.
  </action>
  <verify>
The curl command returns a JSON response with success: true and data containing content and post_id.
  </verify>
  <done>
Content generation webhook responds with valid AI-generated content. The workflow is fully operational.
  </done>
</task>

</tasks>

<verification>
1. N8N credentials page shows "Anthropic API Key" and "Supabase Service Role" credentials
2. All three DraggonnB workflows show "Active" status
3. curl POST to /webhook/generate-content returns AI-generated content
4. npm run build passes
</verification>

<success_criteria>
- Content generator webhook returns valid JSON with success: true
- Response includes AI-generated content (not error message)
- All three DraggonnB workflows are published and active
- Webhook URLs in code match deployed workflow paths
</success_criteria>

<output>
After completion, create `.planning/phases/04-n8n-automation/04-01-SUMMARY.md`
</output>
