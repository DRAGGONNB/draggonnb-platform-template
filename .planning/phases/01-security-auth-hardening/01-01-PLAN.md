---
phase: 01-security-auth-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/supabase/admin.ts
  - app/api/webhooks/payfast/route.ts
  - app/api/email/webhooks/route.ts
  - scripts/rls-policies.sql
autonomous: true

must_haves:
  truths:
    - "PayFast ITN webhook can write to organizations and subscription_history tables when RLS is enabled"
    - "Resend email webhook can write to email_sends table when RLS is enabled"
    - "A Supabase query using the anon key cannot read or write another organization's data"
    - "All org-scoped tables have RLS enabled with organization-based policies"
  artifacts:
    - path: "lib/supabase/admin.ts"
      provides: "Admin Supabase client that bypasses RLS using service role key"
      exports: ["createAdminClient"]
    - path: "scripts/rls-policies.sql"
      provides: "SQL script to enable RLS and create policies on all org-scoped tables"
      contains: "ENABLE ROW LEVEL SECURITY"
    - path: "app/api/webhooks/payfast/route.ts"
      provides: "PayFast webhook using admin client instead of server client"
      contains: "createAdminClient"
  key_links:
    - from: "app/api/webhooks/payfast/route.ts"
      to: "lib/supabase/admin.ts"
      via: "import createAdminClient"
      pattern: "import.*createAdminClient.*from.*lib/supabase/admin"
    - from: "app/api/email/webhooks/route.ts"
      to: "lib/supabase/admin.ts"
      via: "import createAdminClient"
      pattern: "import.*createAdminClient.*from.*lib/supabase/admin"
---

<objective>
Create the admin Supabase client for webhook handlers and generate the complete RLS policy SQL script for all organization-scoped tables.

Purpose: Without RLS, any authenticated user can read/write any organization's data. Without the admin client, webhook handlers (PayFast, Resend) will break when RLS is enabled because they have no user context. This plan creates both so RLS can be safely enabled.

Output: `lib/supabase/admin.ts` (admin client), `scripts/rls-policies.sql` (SQL to run in Supabase dashboard), updated webhook handlers using admin client.
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris Terblanche\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-auth-hardening/01-RESEARCH.md
@lib/supabase/server.ts
@lib/supabase/client.ts
@app/api/webhooks/payfast/route.ts
@app/api/email/webhooks/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin Supabase client and update webhook handlers</name>
  <files>
    lib/supabase/admin.ts
    app/api/webhooks/payfast/route.ts
    app/api/email/webhooks/route.ts
  </files>
  <action>
    1. Create `lib/supabase/admin.ts` with a `createAdminClient()` function:
       - Import `createClient` from `@supabase/supabase-js` (NOT from `@supabase/ssr`)
       - Read `NEXT_PUBLIC_SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` from process.env
       - Throw descriptive error if either is missing
       - Return `createClient(url, serviceKey, { auth: { autoRefreshToken: false, persistSession: false } })`
       - Add JSDoc comment: "Admin client bypasses RLS. Use ONLY in webhook handlers that validate signatures."

    2. Update `app/api/webhooks/payfast/route.ts`:
       - Change import from `import { createClient } from '@/lib/supabase/server'` to `import { createAdminClient } from '@/lib/supabase/admin'`
       - Change line `const supabase = await createClient()` to `const supabase = createAdminClient()` (no await needed -- it's synchronous)
       - Keep all existing logic (signature validation, amount validation, status handling) unchanged

    3. Update `app/api/email/webhooks/route.ts`:
       - Change import from `import { createClient } from '@/lib/supabase/server'` to `import { createAdminClient } from '@/lib/supabase/admin'`
       - Change all `await createClient()` calls to `createAdminClient()`
       - This webhook handles Resend delivery notifications -- needs admin access to update email_sends without user context
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no TypeScript errors. Run `npm run build` to verify compilation succeeds. Grep for `createAdminClient` in both webhook files to confirm import is correct.
  </verify>
  <done>
    `lib/supabase/admin.ts` exports `createAdminClient`. Both webhook handlers import and use admin client. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate comprehensive RLS policy SQL script</name>
  <files>
    scripts/rls-policies.sql
  </files>
  <action>
    Create `scripts/rls-policies.sql` that the user runs in the Supabase SQL Editor. The script must:

    1. **Enable RLS on all org-scoped tables.** Based on the existing schema (65+ tables documented in CLAUDE.md), create policies for these core tables that the app actively queries:
       - `organizations` (special: users can read their own org, no cross-org access)
       - `users` (special: can read users in same org, can insert own record during signup, can update own record)
       - `contacts`, `companies`, `deals`, `activities` (CRM -- standard org-scoped CRUD)
       - `email_campaigns`, `email_templates`, `email_sequences`, `email_sends`, `email_unsubscribes` (Email -- standard org-scoped CRUD)
       - `social_posts`, `social_accounts`, `content_queue`, `content_templates` (Social -- standard org-scoped CRUD)
       - `client_usage_metrics`, `subscription_history` (Billing -- org-scoped read, admin-client writes)
       - `analytics_snapshots`, `platform_metrics` (Analytics -- org-scoped read)
       - `notifications`, `audit_log` (System -- org-scoped CRUD)

    2. **Standard org-scoped policy template** (use for most tables):
       ```sql
       ALTER TABLE {table} ENABLE ROW LEVEL SECURITY;

       CREATE POLICY "Org members can select" ON {table}
         FOR SELECT TO authenticated
         USING (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()));

       CREATE POLICY "Org members can insert" ON {table}
         FOR INSERT TO authenticated
         WITH CHECK (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()));

       CREATE POLICY "Org members can update" ON {table}
         FOR UPDATE TO authenticated
         USING (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()))
         WITH CHECK (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()));

       CREATE POLICY "Org members can delete" ON {table}
         FOR DELETE TO authenticated
         USING (organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid()));
       ```

    3. **Special policies:**
       - `users` table: INSERT policy `WITH CHECK (id = auth.uid())` -- users can only insert their own record during signup. SELECT policy allows viewing users in same org OR own record. UPDATE limited to own record.
       - `organizations` table: INSERT policy `WITH CHECK (true)` for authenticated (needed during signup). SELECT limited to own org (via users table join). UPDATE limited to own org.
       - `subscription_history`: SELECT only for org members (no INSERT/UPDATE/DELETE -- admin client handles writes from webhooks).
       - `client_usage_metrics`: SELECT for org members, no direct writes (admin client handles).

    4. **Add performance indexes** on `organization_id` for every table that gets a policy:
       ```sql
       CREATE INDEX IF NOT EXISTS idx_{table}_organization_id ON {table}(organization_id);
       ```

    5. **Use IF NOT EXISTS / DROP POLICY IF EXISTS** pattern so script is idempotent (safe to run multiple times).

    6. **Add verification query at the end:**
       ```sql
       -- Verify RLS is enabled
       SELECT tablename, rowsecurity FROM pg_tables
       WHERE schemaname = 'public' AND rowsecurity = true
       ORDER BY tablename;
       ```

    Add a comment header explaining: "Run this script in the Supabase SQL Editor. It enables RLS on all org-scoped tables and creates policies for organization-level data isolation. Safe to run multiple times (idempotent)."
  </action>
  <verify>
    Read the generated SQL file and verify: (a) RLS is enabled on at least 15 tables, (b) users table has special INSERT policy with `id = auth.uid()`, (c) organizations table has INSERT policy for signup, (d) indexes are created on all organization_id columns, (e) verification query exists at the end.
  </verify>
  <done>
    `scripts/rls-policies.sql` exists with idempotent RLS policies for all org-scoped tables, special signup policies for users and organizations, performance indexes, and a verification query. Script is ready to paste into Supabase SQL Editor.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `lib/supabase/admin.ts` exists and exports `createAdminClient`
3. `app/api/webhooks/payfast/route.ts` imports from `@/lib/supabase/admin`
4. `app/api/email/webhooks/route.ts` imports from `@/lib/supabase/admin`
5. `scripts/rls-policies.sql` contains RLS policies for 15+ tables
6. Users table has INSERT policy with `id = auth.uid()` (signup support)
7. Organizations table has INSERT policy for authenticated users (signup support)
</verification>

<success_criteria>
- Admin Supabase client exists and is used by both webhook handlers
- RLS policy SQL script covers all org-scoped tables with proper CRUD policies
- Special signup-safe policies exist for users and organizations tables
- Performance indexes on organization_id columns are included
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-auth-hardening/01-01-SUMMARY.md`
</output>
