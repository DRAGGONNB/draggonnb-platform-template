---
phase: 01-security-auth-hardening
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - lib/supabase/middleware.ts
  - app/signup/page.tsx
autonomous: true

must_haves:
  truths:
    - "Visiting /crm, /email, /content-generator, or /dashboard without being logged in redirects to /login"
    - "A new user can sign up and their account is linked to an organization via organization_id"
    - "Authenticated users visiting /login or /signup are redirected to /dashboard"
    - "Signup creates organization, then user record with organization_id, then usage metrics -- in that order"
  artifacts:
    - path: "lib/supabase/middleware.ts"
      provides: "Middleware protecting all dashboard routes, not just /dashboard"
      contains: "/crm"
    - path: "app/signup/page.tsx"
      provides: "Signup flow that works with RLS enabled"
      contains: "organization_id"
  key_links:
    - from: "lib/supabase/middleware.ts"
      to: "middleware.ts"
      via: "updateSession export consumed by root middleware"
      pattern: "protectedRoutes.*crm.*email"
    - from: "app/signup/page.tsx"
      to: "lib/supabase/client.ts"
      via: "uses browser Supabase client for signup"
      pattern: "createClient.*from.*lib/supabase/client"
---

<objective>
Fix middleware route protection and ensure the signup flow works correctly when RLS is enabled.

Purpose: Currently middleware only protects `/dashboard` -- users can access `/crm`, `/email`, and `/content-generator` without logging in. The signup flow creates organizations and users but will fail under RLS because the INSERT policies require `auth.uid()` to be available (which it is after `signUp()` completes). This plan fixes both issues.

Output: Updated middleware with full route protection, updated signup flow verified to work with RLS.
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris Terblanche\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-auth-hardening/01-RESEARCH.md
@.planning/phases/01-security-auth-hardening/01-01-SUMMARY.md
@lib/supabase/middleware.ts
@middleware.ts
@app/signup/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand middleware to protect all dashboard routes</name>
  <files>
    lib/supabase/middleware.ts
  </files>
  <action>
    Update the `protectedRoutes` array in `lib/supabase/middleware.ts` (line 60) from:
    ```typescript
    const protectedRoutes = ['/dashboard']
    ```
    to:
    ```typescript
    const protectedRoutes = ['/dashboard', '/crm', '/email', '/content-generator']
    ```

    Keep everything else in the middleware unchanged -- the existing logic for token refresh, cookie handling, auth route redirect (login/signup -> dashboard for authenticated users), and the matcher pattern in `middleware.ts` are already correct.

    Add a comment above the array: `// All routes requiring authentication -- add new protected routes here`
  </action>
  <verify>
    Run `npm run build` to verify the middleware compiles. Grep for `/crm` in `lib/supabase/middleware.ts` to confirm it's in the protected routes list.
  </verify>
  <done>
    Middleware protects `/dashboard`, `/crm`, `/email`, and `/content-generator`. Unauthenticated users accessing any of these routes are redirected to `/login` with a `?redirect=` parameter preserving their intended destination.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and fix signup flow for RLS compatibility</name>
  <files>
    app/signup/page.tsx
  </files>
  <action>
    Review the current signup flow in `app/signup/page.tsx` (lines 70-155). The flow is:
    1. `supabase.auth.signUp()` -- creates auth.users record
    2. Insert into `organizations` table
    3. Insert into `users` table with `organization_id`
    4. Insert into `client_usage_metrics`

    **Issue:** After `signUp()`, the Supabase client has the new user's session (auth.uid() is available). The RLS policies from Plan 01 allow:
    - `organizations` INSERT for any authenticated user (`WITH CHECK (true)`)
    - `users` INSERT only if `id = auth.uid()`
    - `client_usage_metrics` INSERT for org members

    The problem is step 4: after inserting the user record in step 3, the RLS policy for `client_usage_metrics` requires `organization_id IN (SELECT organization_id FROM users WHERE id = auth.uid())`. Since step 3 just inserted the user record, this should work because the user record with `organization_id` now exists.

    **Verify the signup flow is correct by checking:**
    - Step 1 (`signUp`) sets `auth.uid()` -- YES, Supabase client gets session immediately
    - Step 2 (org insert) uses `WITH CHECK (true)` policy -- YES, allowed for authenticated
    - Step 3 (user insert) uses `id = auth.uid()` check -- YES, `authData.user.id` matches `auth.uid()`
    - Step 4 (usage metrics insert) requires user to be in the org -- YES, step 3 just inserted the user-org link

    **If the flow is correct as-is (likely), make these minor improvements:**
    - Add error handling for the case where `signUp` returns a user but the session is not immediately available (Supabase email confirmation mode). Check `authData.session` -- if null, show a message about email confirmation instead of proceeding to org/user creation.
    - Ensure the cleanup on user creation failure (line 124: delete org) also uses proper error handling -- wrap in try/catch so cleanup failure doesn't mask the original error.

    **Do NOT change the overall flow structure** -- it's correct for RLS. The org insert before user insert is the right order because the user needs the org ID.
  </action>
  <verify>
    Run `npm run build` to verify the signup page compiles. Read the updated file and verify: (a) signUp is called first, (b) organization insert follows, (c) user insert follows with organization_id, (d) email confirmation case is handled.
  </verify>
  <done>
    Signup flow is verified RLS-compatible: signUp -> org insert -> user insert -> usage metrics. Email confirmation edge case handled. Cleanup on failure has proper error handling. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `lib/supabase/middleware.ts` contains `/crm`, `/email`, `/content-generator` in protected routes
3. Signup flow order: signUp -> organizations insert -> users insert -> client_usage_metrics insert
4. Signup handles email confirmation case (session may be null)
</verification>

<success_criteria>
- All dashboard routes (/dashboard, /crm, /email, /content-generator) are protected by middleware
- Signup flow works with RLS enabled (correct operation order, proper auth.uid() availability)
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-auth-hardening/01-02-SUMMARY.md`
</output>
