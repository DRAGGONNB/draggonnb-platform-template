---
phase: 01-security-auth-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/security/email-tokens.ts
  - lib/security/url-validator.ts
  - lib/email/resend.ts
  - app/api/email/track/route.ts
  - app/api/setup/route.ts
  - lib/payments/payfast.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Email unsubscribe tokens are HMAC-signed and cannot be forged by modifying the base64 payload"
    - "Email click tracking rejects non-http(s) redirect URLs (javascript:, data:, file: schemes blocked)"
    - "Setup API returns 503 if SETUP_SECRET env var is not set -- no hardcoded fallback secret"
    - "PayFast logs a warning when PAYFAST_MODE=production and PAYFAST_PASSPHRASE is missing"
    - "Environment variable names in .env.example match what the code actually reads"
  artifacts:
    - path: "lib/security/email-tokens.ts"
      provides: "HMAC token generation and verification for email unsubscribe"
      exports: ["generateUnsubscribeToken", "verifyUnsubscribeToken"]
    - path: "lib/security/url-validator.ts"
      provides: "URL validation to prevent open redirects"
      exports: ["isValidRedirectUrl"]
    - path: "app/api/setup/route.ts"
      provides: "Setup API without hardcoded secret fallback"
      contains: "SETUP_SECRET not configured"
    - path: "app/api/email/track/route.ts"
      provides: "Click tracking with URL validation"
      contains: "isValidRedirectUrl"
  key_links:
    - from: "lib/email/resend.ts"
      to: "lib/security/email-tokens.ts"
      via: "generateUnsubscribeUrl uses HMAC token"
      pattern: "import.*generateUnsubscribeToken.*from.*lib/security/email-tokens"
    - from: "app/api/email/track/route.ts"
      to: "lib/security/url-validator.ts"
      via: "click handler validates redirect URL"
      pattern: "import.*isValidRedirectUrl.*from.*lib/security/url-validator"
---

<objective>
Harden email security (HMAC tokens, URL validation), remove hardcoded secrets, add PayFast production safeguard, and align environment variable names.

Purpose: The current unsubscribe tokens are plain base64 (trivially forgeable), click tracking allows open redirects to any URL, the setup API has a hardcoded default secret, and PayFast has no warning when passphrase is missing in production mode. This plan fixes all four security gaps.

Output: HMAC-signed email tokens, URL validation for click tracking, hardened setup API, PayFast passphrase warning, aligned env vars.
</objective>

<execution_context>
@C:\Users\Chris Terblanche\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris Terblanche\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-auth-hardening/01-RESEARCH.md
@lib/email/resend.ts
@app/api/email/track/route.ts
@app/api/setup/route.ts
@lib/payments/payfast.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HMAC email tokens and URL validator, wire into existing code</name>
  <files>
    lib/security/email-tokens.ts
    lib/security/url-validator.ts
    lib/email/resend.ts
    app/api/email/track/route.ts
  </files>
  <action>
    1. **Create `lib/security/email-tokens.ts`:**
       - Import `createHmac` and `timingSafeEqual` from Node.js `crypto` module
       - Export `generateUnsubscribeToken(emailSendId: string, contactEmail: string): string`:
         * Read `EMAIL_TRACKING_SECRET` from `process.env` -- throw if missing
         * Create payload: `${emailSendId}:${contactEmail}:${Date.now()}`
         * Sign with `createHmac('sha256', secret).update(payload).digest('hex')`
         * Return `Buffer.from(\`${payload}:${signature}\`).toString('base64url')`
       - Export `verifyUnsubscribeToken(token: string): { valid: boolean; emailSendId?: string; contactEmail?: string; error?: string }`:
         * Decode base64url token, split by `:` (expect 4 parts: id, email, timestamp, signature)
         * Check token age: reject if older than 30 days
         * Recompute HMAC and use `timingSafeEqual` to compare
         * Return parsed data if valid, error message if not

    2. **Create `lib/security/url-validator.ts`:**
       - Export `isValidRedirectUrl(url: string): boolean`:
         * Try `new URL(url)` -- return false on parse error
         * Check `parsed.protocol` is `http:` or `https:` -- reject `javascript:`, `data:`, `file:`, etc.
         * Return true if protocol is valid
         * Do NOT add domain allowlist -- email click tracking redirects to arbitrary external URLs by design

    3. **Update `lib/email/resend.ts` -- replace unsubscribe URL generation:**
       - Import `generateUnsubscribeToken` from `@/lib/security/email-tokens`
       - In `generateUnsubscribeUrl()` function (lines 236-249): Replace the plain base64 token with HMAC-signed token:
         * Instead of `Buffer.from(JSON.stringify({...})).toString('base64')`, call `generateUnsubscribeToken(organizationId, email)`
         * Note: The function signature changes slightly -- it currently takes `(organizationId, email, type)` but the HMAC token only needs `(emailSendId, contactEmail)`. Since we don't have `emailSendId` at URL generation time, use `organizationId` as the first parameter (it serves as the identifying context). Keep the function signature as `(organizationId, email, type)` for backward compatibility.
         * If `EMAIL_TRACKING_SECRET` is not set, fall back to the current plain base64 approach with a `console.warn` -- this allows the app to work without the secret configured but logs a warning
       - Apply same HMAC pattern to `generatePreferencesUrl()` (lines 254-265)

    4. **Update `app/api/email/track/route.ts` -- add URL validation for click tracking:**
       - Import `isValidRedirectUrl` from `@/lib/security/url-validator`
       - In the click tracking handler (line 80-123), after decoding the URL (line 86), add validation:
         ```typescript
         if (!isValidRedirectUrl(decodedUrl)) {
           return NextResponse.json({ error: 'Invalid redirect URL' }, { status: 400 })
         }
         ```
       - Also add the same validation in the error catch block (line 141-142) where it tries to redirect on error -- add `isValidRedirectUrl` check before the fallback redirect
  </action>
  <verify>
    Run `npm run build` to verify all files compile. Grep for `isValidRedirectUrl` in `app/api/email/track/route.ts`. Grep for `generateUnsubscribeToken` in `lib/email/resend.ts`. Verify `lib/security/email-tokens.ts` contains `timingSafeEqual`.
  </verify>
  <done>
    HMAC-signed unsubscribe tokens replace plain base64. Click tracking validates redirect URLs (rejects non-http/https). Both new security modules exist and are wired into existing email code. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix setup API secret, PayFast passphrase warning, and env var alignment</name>
  <files>
    app/api/setup/route.ts
    lib/payments/payfast.ts
    .env.example
  </files>
  <action>
    1. **Fix `app/api/setup/route.ts` (SEC-05):**
       - Remove line 8: `const SETUP_SECRET = process.env.SETUP_SECRET || 'draggonnb-setup-2024'`
       - Replace with: `const SETUP_SECRET = process.env.SETUP_SECRET`
       - In the POST handler, add a check before the secret comparison:
         ```typescript
         if (!SETUP_SECRET) {
           return NextResponse.json(
             { error: 'Setup endpoint disabled - SETUP_SECRET not configured' },
             { status: 503 }
           )
         }
         ```
       - Keep the rest of the handler unchanged (admin client creation, table checks, etc.)

    2. **Add PayFast passphrase production warning (SEC-08):**
       - In `lib/payments/payfast.ts`, find the `createPayFastSubscription` function (around line 139) where it reads `process.env.PAYFAST_PASSPHRASE`
       - After reading the passphrase, add:
         ```typescript
         if (mode === 'production' && !passphrase) {
           console.warn('[PayFast] WARNING: PAYFAST_PASSPHRASE is not set but PAYFAST_MODE is production. Signature validation will fail.')
         }
         ```
       - Check if this warning already exists somewhere in the file. If it does, ensure it's in the right location (subscription creation and signature validation functions).

    3. **Align environment variable names (SEC-09):**
       - Audit: Compare every `process.env.XXX` reference in the codebase against `.env.example`
       - Known mismatches to check:
         * `NEXT_PUBLIC_APP_URL` -- used in `lib/payments/payfast.ts` (line 218-220 as fallback) and `lib/email/resend.ts` but NOT in `.env.example`. **Add it to `.env.example`.**
         * `EMAIL_TRACKING_SECRET` -- used in the new `lib/security/email-tokens.ts` but NOT in `.env.example`. **Add it to `.env.example`** under the Email Configuration section with comment "Secret for HMAC-signing email tracking tokens (min 32 chars, generate with: openssl rand -hex 32)".
         * `EMAIL_FROM` and `EMAIL_FROM_NAME` and `EMAIL_REPLY_TO` -- already in `.env.example`, verify they match code usage in `lib/email/resend.ts`
       - Update `.env.example` to add any missing variables with descriptive comments
       - Add `NEXT_PUBLIC_APP_URL` to the Supabase section with comment "Your app's public URL (used for email links, payment callbacks)"
  </action>
  <verify>
    Run `npm run build` to verify all changes compile. Read `app/api/setup/route.ts` and verify no hardcoded secret fallback exists. Read `.env.example` and verify `EMAIL_TRACKING_SECRET` and `NEXT_PUBLIC_APP_URL` are present.
  </verify>
  <done>
    Setup API fails with 503 if SETUP_SECRET not set (no hardcoded fallback). PayFast warns on missing passphrase in production mode. `.env.example` includes all variables the code reads, including EMAIL_TRACKING_SECRET and NEXT_PUBLIC_APP_URL. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `app/api/setup/route.ts` does not contain `'draggonnb-setup-2024'`
3. `lib/security/email-tokens.ts` uses `timingSafeEqual` for HMAC comparison
4. `lib/security/url-validator.ts` rejects `javascript:` protocol URLs
5. `app/api/email/track/route.ts` validates redirect URLs before redirecting
6. `lib/email/resend.ts` uses HMAC-signed tokens for unsubscribe URLs
7. `.env.example` contains `EMAIL_TRACKING_SECRET` and `NEXT_PUBLIC_APP_URL`
8. `lib/payments/payfast.ts` warns when production mode has no passphrase
</verification>

<success_criteria>
- No hardcoded secrets remain in the codebase
- Unsubscribe tokens are HMAC-signed (SHA256) with timing-safe comparison
- Click tracking validates URL protocol before redirecting
- PayFast logs warning when passphrase missing in production mode
- .env.example is fully aligned with codebase env var usage
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-auth-hardening/01-03-SUMMARY.md`
</output>
